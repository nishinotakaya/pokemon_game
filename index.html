<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポケモンバトル：ピカチュウ vs イーブイ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 17 CDN -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* バトルアニメーション定義 */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.8); }
        }
        
        .shake { animation: shake 0.5s ease-in-out; }
        .bounce { animation: bounce 1s ease-in-out infinite; }
        .flash { animation: flash 0.3s ease-in-out; }
        .slide-in { animation: slideIn 0.8s ease-out; }
        .slide-in-right { animation: slideInRight 0.8s ease-out; }
        .glow { animation: glow 2s ease-in-out infinite; }
        
        /* HPバーアニメーション */
        .hp-bar {
            transition: width 0.8s ease-in-out;
        }
        
        /* バトルフィールド背景 */
        .battle-field {
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            position: relative;
            overflow: hidden;
        }
        
        .battle-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.3) 0%, transparent 50%);
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const PokemonBattleComponent = () => {
            // ポケモンデータ
            const pokemonData = {
                pikachu: {
                    name: "ピカチュウ",
                    maxHP: 100,
                    type: "でんき",
                    image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
                    moves: [
                        { name: "でんきショック", power: 25, type: "でんき" },
                        { name: "アイアンテール", power: 35, type: "はがね" },
                        { name: "でんこうせっか", power: 20, type: "ノーマル" },
                        { name: "10まんボルト", power: 45, type: "でんき" }
                    ]
                },
                eevee: {
                    name: "イーブイ",
                    maxHP: 100,
                    type: "ノーマル",
                    image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/133.png",
                    moves: [
                        { name: "たいあたり", power: 25, type: "ノーマル" },
                        { name: "すなかけ", power: 15, type: "じめん" },
                        { name: "にどげり", power: 30, type: "かくとう" },
                        { name: "シャドーボール", power: 40, type: "ゴースト" }
                    ]
                }
            };

            // 状態管理
            const [gameState, setGameState] = React.useState({
                pikachu: { ...pokemonData.pikachu, currentHP: 100 },
                eevee: { ...pokemonData.eevee, currentHP: 100 },
                currentTurn: "player", // "player" or "enemy"
                battleLog: [],
                isGameOver: false,
                winner: null,
                animationState: {
                    pikachuShake: false,
                    eeveeShake: false,
                    pikachuFlash: false,
                    eeveeFlash: false,
                    battleMessage: ""
                }
            });

            // ダメージ計算関数（命中率システム追加）
            const calculateDamage = (move, attacker, defender) => {
                // 命中率判定（95%の確率で命中）
                const hitChance = Math.random();
                if (hitChance > 0.95) {
                    return 0; // 攻撃外れ
                }

                const baseDamage = move.power;
                const randomFactor = 0.8 + Math.random() * 0.4; // 0.8-1.2倍のランダム要素
                let damage = Math.floor(baseDamage * randomFactor);
                
                // タイプ相性システム（拡張版）
                const typeChart = {
                    'でんき': { 'ノーマル': 1.0, 'じめん': 0.5 },
                    'はがね': { 'ノーマル': 1.2 },
                    'ノーマル': { 'ゴースト': 0.0 },
                    'じめん': { 'でんき': 2.0 },
                    'かくとう': { 'ノーマル': 2.0 },
                    'ゴースト': { 'ノーマル': 0.0 }
                };
                
                const effectiveness = typeChart[move.type]?.[defender.type] ?? 1.0;
                damage = Math.floor(damage * effectiveness);
                
                return Math.max(1, damage); // 最低1ダメージ
            };

            // アニメーション制御関数
            const triggerAnimation = (animationType, target, duration = 500) => {
                setGameState(prev => ({
                    ...prev,
                    animationState: {
                        ...prev.animationState,
                        [target]: true
                    }
                }));

                setTimeout(() => {
                    setGameState(prev => ({
                        ...prev,
                        animationState: {
                            ...prev.animationState,
                            [target]: false
                        }
                    }));
                }, duration);
            };

            // バトルログ追加関数
            const addToBattleLog = (message) => {
                setGameState(prev => ({
                    ...prev,
                    battleLog: [...prev.battleLog.slice(-4), message] // 最新5件まで保持
                }));
            };

            // 攻撃処理関数（攻撃外れ処理追加）
            const performAttack = (attackerKey, defenderKey, moveIndex) => {
                if (gameState.isGameOver) return;

                const attacker = gameState[attackerKey];
                const defender = gameState[defenderKey];
                const move = attacker.moves[moveIndex];
                
                const damage = calculateDamage(move, attacker, defender);
                
                // アニメーション実行
                const attackerAnimationTarget = attackerKey === "pikachu" ? "pikachuFlash" : "eeveeFlash";
                triggerAnimation("flash", attackerAnimationTarget, 300);
                
                // バトルログ更新
                addToBattleLog(`${attacker.name}の${move.name}！`);
                
                if (damage === 0) {
                    // 攻撃外れ
                    addToBattleLog(`${attacker.name}の攻撃は外れた！`);
                    
                    // ターン交代
                    setGameState(prev => ({
                        ...prev,
                        currentTurn: prev.currentTurn === "player" ? "enemy" : "player"
                    }));
                    return;
                }
                
                const newDefenderHP = Math.max(0, defender.currentHP - damage);
                const defenderAnimationTarget = defenderKey === "pikachu" ? "pikachuShake" : "eeveeShake";
                
                setTimeout(() => {
                    triggerAnimation("shake", defenderAnimationTarget, 500);
                }, 200);

                addToBattleLog(`${defender.name}に${damage}ダメージ！`);

                // HP更新とゲーム状態更新
                setGameState(prev => {
                    const newState = {
                        ...prev,
                        [defenderKey]: {
                            ...prev[defenderKey],
                            currentHP: newDefenderHP
                        }
                    };

                    // ゲーム終了判定
                    if (newDefenderHP <= 0) {
                        newState.isGameOver = true;
                        newState.winner = attackerKey;
                        setTimeout(() => {
                            addToBattleLog(`${defender.name}は倒れた！`);
                            addToBattleLog(`${attacker.name}の勝利！`);
                        }, 300);
                    } else {
                        // ターン交代
                        newState.currentTurn = prev.currentTurn === "player" ? "enemy" : "player";
                    }

                    return newState;
                });
            };

            // プレイヤー攻撃関数
            const playerAttack = (moveIndex) => {
                if (gameState.currentTurn === "player" && !gameState.isGameOver) {
                    performAttack("pikachu", "eevee", moveIndex);
                }
            };

            // 敵AI攻撃関数（1.5秒遅延に変更）
            const enemyAttack = () => {
                if (gameState.currentTurn === "enemy" && !gameState.isGameOver) {
                    const randomMoveIndex = Math.floor(Math.random() * 4);
                    setTimeout(() => {
                        performAttack("eevee", "pikachu", randomMoveIndex);
                    }, 1500); // 1.5秒後に攻撃
                }
            };

            // 敵のターン自動実行
            React.useEffect(() => {
                if (gameState.currentTurn === "enemy" && !gameState.isGameOver) {
                    enemyAttack();
                }
            }, [gameState.currentTurn]);

            // ゲームリセット関数
            const resetGame = () => {
                setGameState({
                    pikachu: { ...pokemonData.pikachu, currentHP: 100 },
                    eevee: { ...pokemonData.eevee, currentHP: 100 },
                    currentTurn: "player",
                    battleLog: ["バトル開始！"],
                    isGameOver: false,
                    winner: null,
                    animationState: {
                        pikachuShake: false,
                        eeveeShake: false,
                        pikachuFlash: false,
                        eeveeFlash: false,
                        battleMessage: ""
                    }
                });
            };

            // 初期化
            React.useEffect(() => {
                resetGame();
            }, []);

            // HPバーの色を決定する関数
            const getHPBarColor = (currentHP, maxHP) => {
                const percentage = (currentHP / maxHP) * 100;
                if (percentage > 60) return 'bg-green-500';
                if (percentage > 30) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            // 技タイプ別の色を決定する関数
            const getMoveTypeColor = (type) => {
                const colors = {
                    'でんき': 'bg-yellow-400 hover:bg-yellow-500',
                    'はがね': 'bg-gray-400 hover:bg-gray-500',
                    'ノーマル': 'bg-gray-300 hover:bg-gray-400 text-gray-800',
                    'じめん': 'bg-amber-600 hover:bg-amber-700',
                    'かくとう': 'bg-red-600 hover:bg-red-700',
                    'ゴースト': 'bg-purple-600 hover:bg-purple-700'
                };
                return colors[type] || 'bg-blue-500 hover:bg-blue-600';
            };

            // UI レンダリング
            return React.createElement('div', {
                className: 'min-h-screen battle-field p-4'
            }, [
                // ヘッダー
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center mb-6'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg'
                    }, 'ポケモンバトル'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg text-white drop-shadow-md'
                    }, 'ピカチュウ vs イーブイ')
                ]),

                // メインバトルエリア
                React.createElement('div', {
                    key: 'battle-area',
                    className: 'max-w-6xl mx-auto bg-white/10 backdrop-blur-sm rounded-xl p-6 shadow-2xl'
                }, [
                    // ポケモン表示エリア
                    React.createElement('div', {
                        key: 'pokemon-area',
                        className: 'grid md:grid-cols-2 gap-8 mb-8'
                    }, [
                        // ピカチュウ（プレイヤー）
                        React.createElement('div', {
                            key: 'pikachu-section',
                            className: `text-center slide-in ${gameState.animationState.pikachuShake ? 'shake' : ''} ${gameState.animationState.pikachuFlash ? 'flash' : ''}`
                        }, [
                            React.createElement('h2', {
                                key: 'pikachu-name',
                                className: 'text-2xl font-bold text-yellow-400 mb-2'
                            }, `${gameState.pikachu.name} (プレイヤー)`),
                            React.createElement('div', {
                                key: 'pikachu-type',
                                className: 'inline-block bg-yellow-500 text-black px-3 py-1 rounded-full text-sm font-bold mb-4'
                            }, gameState.pikachu.type + 'タイプ'),
                            React.createElement('img', {
                                key: 'pikachu-image',
                                src: gameState.pikachu.image,
                                alt: gameState.pikachu.name,
                                className: 'w-32 h-32 mx-auto mb-4 bounce',
                                style: { imageRendering: 'pixelated' }
                            }),
                            // HP表示
                            React.createElement('div', {
                                key: 'pikachu-hp',
                                className: 'mb-4'
                            }, [
                                React.createElement('div', {
                                    key: 'pikachu-hp-text',
                                    className: 'text-white font-bold mb-2'
                                }, `HP: ${gameState.pikachu.currentHP}/${gameState.pikachu.maxHP}`),
                                React.createElement('div', {
                                    key: 'pikachu-hp-bar-bg',
                                    className: 'w-full bg-gray-700 rounded-full h-4'
                                }, React.createElement('div', {
                                    key: 'pikachu-hp-bar',
                                    className: `hp-bar h-4 rounded-full transition-all duration-500 ${getHPBarColor(gameState.pikachu.currentHP, gameState.pikachu.maxHP)}`,
                                    style: { width: `${(gameState.pikachu.currentHP / gameState.pikachu.maxHP) * 100}%` }
                                }))
                            ])
                        ]),

                        // イーブイ（CPU）
                        React.createElement('div', {
                            key: 'eevee-section',
                            className: `text-center slide-in-right ${gameState.animationState.eeveeShake ? 'shake' : ''} ${gameState.animationState.eeveeFlash ? 'flash' : ''}`
                        }, [
                            React.createElement('h2', {
                                key: 'eevee-name',
                                className: 'text-2xl font-bold text-amber-400 mb-2'
                            }, `${gameState.eevee.name} (CPU)`),
                            React.createElement('div', {
                                key: 'eevee-type',
                                className: 'inline-block bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-bold mb-4'
                            }, gameState.eevee.type + 'タイプ'),
                            React.createElement('img', {
                                key: 'eevee-image',
                                src: gameState.eevee.image,
                                alt: gameState.eevee.name,
                                className: 'w-32 h-32 mx-auto mb-4 bounce',
                                style: { imageRendering: 'pixelated' }
                            }),
                            // HP表示
                            React.createElement('div', {
                                key: 'eevee-hp',
                                className: 'mb-4'
                            }, [
                                React.createElement('div', {
                                    key: 'eevee-hp-text',
                                    className: 'text-white font-bold mb-2'
                                }, `HP: ${gameState.eevee.currentHP}/${gameState.eevee.maxHP}`),
                                React.createElement('div', {
                                    key: 'eevee-hp-bar-bg',
                                    className: 'w-full bg-gray-700 rounded-full h-4'
                                }, React.createElement('div', {
                                    key: 'eevee-hp-bar',
                                    className: `hp-bar h-4 rounded-full transition-all duration-500 ${getHPBarColor(gameState.eevee.currentHP, gameState.eevee.maxHP)}`,
                                    style: { width: `${(gameState.eevee.currentHP / gameState.eevee.maxHP) * 100}%` }
                                }))
                            ])
                        ])
                    ]),

                    // ターン表示
                    React.createElement('div', {
                        key: 'turn-indicator',
                        className: 'text-center mb-6'
                    }, React.createElement('div', {
                        key: 'turn-text',
                        className: `inline-block px-6 py-3 rounded-full font-bold text-lg ${
                            gameState.isGameOver 
                                ? 'bg-purple-600 text-white' 
                                : gameState.currentTurn === 'player' 
                                    ? 'bg-blue-600 text-white glow' 
                                    : 'bg-red-600 text-white'
                        }`
                    }, gameState.isGameOver 
                        ? `ゲーム終了！${gameState.winner === 'pikachu' ? 'ピカチュウ' : 'イーブイ'}の勝利！`
                        : gameState.currentTurn === 'player' 
                            ? 'あなたのターン' 
                            : 'CPUのターン')),

                    // 技選択ボタン
                    !gameState.isGameOver && gameState.currentTurn === 'player' && React.createElement('div', {
                        key: 'move-buttons',
                        className: 'grid grid-cols-2 gap-4 mb-6'
                    }, gameState.pikachu.moves.map((move, index) => 
                        React.createElement('button', {
                            key: `move-${index}`,
                            onClick: () => playerAttack(index),
                            className: `p-4 rounded-lg font-bold text-white transition-all duration-200 transform hover:scale-105 active:scale-95 ${getMoveTypeColor(move.type)}`
                        }, [
                            React.createElement('div', {
                                key: 'move-name',
                                className: 'text-lg'
                            }, move.name),
                            React.createElement('div', {
                                key: 'move-details',
                                className: 'text-sm opacity-80'
                            }, `${move.type}タイプ・威力${move.power}`)
                        ])
                    )),

                    // バトルログ
                    React.createElement('div', {
                        key: 'battle-log',
                        className: 'bg-black/50 rounded-lg p-4 h-32 overflow-y-auto mb-6'
                    }, [
                        React.createElement('h3', {
                            key: 'log-title',
                            className: 'text-white font-bold mb-2'
                        }, 'バトルログ'),
                        React.createElement('div', {
                            key: 'log-content',
                            className: 'space-y-1'
                        }, gameState.battleLog.map((log, index) => 
                            React.createElement('div', {
                                key: `log-${index}`,
                                className: 'text-gray-300 text-sm'
                            }, `> ${log}`)
                        ))
                    ]),

                    // リセットボタン
                    React.createElement('div', {
                        key: 'reset-section',
                        className: 'text-center'
                    }, React.createElement('button', {
                        key: 'reset-button',
                        onClick: resetGame,
                        className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95'
                    }, 'ゲームリセット'))
                ])
            ]);
        };

        // レンダリング
        ReactDOM.render(React.createElement(PokemonBattleComponent), document.getElementById('root'));
    </script>
</body>
</html>