<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éù„Ç±„É¢„É≥„Éê„Éà„É´Ôºö„É™„Ç¢„É´„Éê„Éº„Ç∏„Éß„É≥</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 17 CDN -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <!-- „Éù„Ç±„É¢„É≥„Éá„Éº„Çø -->
    <script src="pokemon-data.js"></script>
    <script src="move-data.js"></script>
    <script src="type-effectiveness.js"></script>

    <!-- „Éû„ÉÉ„Éó„Éá„Éº„Çø -->
    <script src="masara_town.js"></script>
    <script src="shion_town.js"></script>

    <style>
        /* „Éê„Éà„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆöÁæ© */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 255, 0, 0.8);
            }
        }

        @keyframes critical {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                filter: brightness(1.5);
            }
        }

        @keyframes statusEffect {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        @keyframes missAnimation {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        .bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        .flash {
            animation: flash 0.3s ease-in-out;
        }

        .slide-in {
            animation: slideIn 0.8s ease-out;
        }

        .slide-in-right {
            animation: slideInRight 0.8s ease-out;
        }

        .glow {
            animation: glow 2s ease-in-out infinite;
        }

        .critical-hit {
            animation: critical 0.6s ease-in-out;
        }

        .status-effect {
            animation: statusEffect 2s ease-in-out infinite;
        }

        .miss-animation {
            animation: missAnimation 2s ease-in-out;
        }

        /* HP„Éê„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .hp-bar {
            transition: width 0.8s ease-in-out;
        }

        /* „Éê„Éà„É´„Éï„Ç£„Éº„É´„ÉâËÉåÊôØ */
        .battle-field {
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #F0E68C 100%);
            position: relative;
            overflow: hidden;
        }

        .battle-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 50%);
            pointer-events: none;
        }

        /* „Éù„Ç±„É¢„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ */
        .pokemon-selector {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .pokemon-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pokemon-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .pokemon-card.selected {
            border: 3px solid #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        /* ÂãùÂà©„É¢„Éº„ÉÄ„É´ */
        @keyframes winScale {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes winPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .win-modal {
            animation: winScale 0.5s ease-out;
        }

        .win-text {
            animation: winPulse 1.5s ease-in-out infinite;
        }

        /* ÊäÄÂêçË°®Á§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes moveNameAppear {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .move-name-display {
            animation: moveNameAppear 0.5s ease-out;
            transform: translate(-50%, -50%);
        }

        /* „Éû„ÉÉ„ÉóÁî®„Çπ„Çø„Ç§„É´ */
        @keyframes walk {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .walk-animation {
            animation: walk 0.5s ease-in-out infinite;
        }

        .grass-tile {
            background: linear-gradient(135deg, #90EE90 0%, #32CD32 100%);
            position: relative;
            cursor: pointer;
        }

        .grass-tile:hover {
            background: linear-gradient(135deg, #98FB98 0%, #50C878 100%);
        }

        .grass-tile::before {
            content: 'üåø';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            opacity: 0.3;
        }

        .path-tile {
            background: linear-gradient(135deg, #D2B48C 0%, #C19A6B 100%);
        }

        .house-tile {
            background: linear-gradient(135deg, #FF6347 0%, #CD5C5C 100%);
        }

        .water-tile {
            background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%);
            position: relative;
        }

        .water-tile::before {
            content: 'üåä';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            opacity: 0.4;
        }

        .pokemon-center-tile {
            background: linear-gradient(135deg, #FF69B4 0%, #FF1493 100%);
            position: relative;
        }

        .player {
            transition: all 0.2s ease-out;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        .fade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 9999;
            pointer-events: none;
            transition: opacity 0.03s linear;
        }

        .encounter-shake {
            animation: encounterShake 0.5s ease-in-out;
        }

        @keyframes encounterShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const PokemonBattleComponent = ({ playerRef, bgmPlayerReady, transitionInfo, navigateToMap }) => {
            /* === BGM Áä∂ÊÖãÁÆ°ÁêÜ (YouTube) === */
            const [bgmState, setBgmState] = React.useState({ isPlaying: false, volume: 0.3 });

            // „Éû„ÉÉ„Éó„Åã„Çâ„ÅÆÈÅ∑ÁßªÊôÇ„ÅØBGM„ÇíËá™ÂãïÁöÑ„Å´ÈñãÂßã
            React.useEffect(() => {
                if (transitionInfo && transitionInfo.bgmStartTime && playerRef.current && bgmPlayerReady) {
                    // „Éû„ÉÉ„Éó„Åã„ÇâÊù•„ÅüÂ†¥Âêà„ÅØ„ÄÅBGM„ÇíÁ∂ôÁ∂öÔºàÊó¢„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åù„ÅÆ„Åæ„ÅæÂÜçÁîüÔºâ
                    try {
                        const player = playerRef.current;
                        if (player.getPlayerState && player.getPlayerState() !== YT.PlayerState.PLAYING) {
                            player.playVideo();
                            setBgmState(prev => ({ ...prev, isPlaying: true }));
                            console.log('„Éû„ÉÉ„Éó„Åã„Çâ„Éê„Éà„É´„Å∏ÔºöBGM„ÇíÁ∂ôÁ∂öÂÜçÁîü');
                        }
                    } catch (error) {
                        console.log('BGMÁ∂ôÁ∂ö„Ç®„É©„Éº:', error);
                    }
                }
            }, [transitionInfo, playerRef, bgmPlayerReady]);

            /* ---- BGM ÂÜçÁîü/ÂÅúÊ≠¢ „Éà„Ç∞„É´ ---- */
            const toggleBGM = () => {
                const player = playerRef.current;
                if (!player) {
                    console.log('YouTube player not ready');
                    return;
                }

                try {
                    if (bgmState.isPlaying) {
                        console.log('Pausing BGM');
                        player.pauseVideo();
                        setBgmState(prev => ({ ...prev, isPlaying: false }));
                    } else {
                        console.log('Starting BGM');
                        // „Éó„É¨„Ç§„É§„Éº„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                        if (player.getPlayerState && player.getPlayerState() !== -1) {
                            player.seekTo(408, true);
                            player.setVolume(bgmState.volume * 100);
                            player.playVideo();
                            setBgmState(prev => ({ ...prev, isPlaying: true }));
                        } else {
                            console.log('Player not ready, retrying...');
                            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å
                            setTimeout(() => {
                                if (player.getPlayerState && player.getPlayerState() !== -1) {
                                    player.seekTo(408, true);
                                    player.setVolume(bgmState.volume * 100);
                                    player.playVideo();
                                    setBgmState(prev => ({ ...prev, isPlaying: true }));
                                }
                            }, 1000);
                        }
                    }
                } catch (error) {
                    console.log('BGM toggle error:', error);
                }
            };

            /* ---- Èü≥ÈáèË™øÊï¥ ---- */
            const adjustVolume = (newVolume) => {
                const player = playerRef.current;
                if (player) {
                    try {
                        player.setVolume(newVolume * 100);
                    } catch (error) {
                        console.log('Volume adjust error:', error);
                    }
                }
                setBgmState(prev => ({ ...prev, volume: newVolume }));
            };

            // „Éù„Ç±„É¢„É≥„Éá„Éº„Çø„Éô„Éº„ÇπÔºàÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            const pokemonDatabase = window.pokemonDatabase || {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆÂü∫Êú¨„Éù„Ç±„É¢„É≥
                pikachu: {
                    name: "„Éî„Ç´„ÉÅ„É•„Ç¶",
                    maxHP: 100,
                    type: "„Åß„Çì„Åç",
                    image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
                    moves: [
                        { name: "„Åß„Çì„Åç„Ç∑„Éß„ÉÉ„ÇØ", power: 40, type: "„Åß„Çì„Åç", accuracy: 100, pp: 30 },
                        { name: "„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã", power: 40, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                        { name: "10„Åæ„Çì„Éú„É´„Éà", power: 90, type: "„Åß„Çì„Åç", accuracy: 100, pp: 15 },
                        { name: "„Åã„Åø„Å™„Çä", power: 110, type: "„Åß„Çì„Åç", accuracy: 70, pp: 10 }
                    ],
                    stats: { attack: 55, defense: 40, speed: 90, special: 50 }
                },
                eevee: {
                    name: "„Ç§„Éº„Éñ„Ç§",
                    maxHP: 100,
                    type: "„Éé„Éº„Éû„É´",
                    image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/133.png",
                    moves: [
                        { name: "„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã", power: 40, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                        { name: "„Åó„Å£„ÅΩ„Çí„Åµ„Çã", power: 0, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                        { name: "„Å®„Å£„Åó„Çì", power: 90, type: "„Éé„Éº„Éû„É´", accuracy: 85, pp: 20 },
                        { name: "„ÅØ„Å≠„Çã", power: 0, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 40 }
                    ],
                    stats: { attack: 55, defense: 50, speed: 55, special: 45 }
                }
            };

            // „Éù„Ç±„É¢„É≥„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÔºàÂêå„Åò„Éù„Ç±„É¢„É≥„Åß„ÇÇÂà•„ÄÖ„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàêÔºâ
            const createPokemonInstance = (pokemonKey, instanceId) => {
                const pokemon = pokemonDatabase[pokemonKey];
                if (!pokemon) return null;

                return {
                    ...pokemon,
                    instanceId: instanceId, // „Ç§„É≥„Çπ„Çø„É≥„ÇπID„ÇíËøΩÂä†
                    currentHP: pokemon.maxHP,
                    status: null,
                    pp: pokemon.moves.reduce((acc, move, index) => {
                        acc[index] = move.pp;
                        return acc;
                    }, {})
                };
            };

            // transitionInfo„Åã„ÇâÊïµ„Éù„Ç±„É¢„É≥„ÇíÂèñÂæó
            const getEnemyPokemonFromTransition = () => {
                if (transitionInfo && transitionInfo.enemyPokemon && window.pokemonDatabase && window.pokemonDatabase[transitionInfo.enemyPokemon]) {
                    return transitionInfo.enemyPokemon;
                }
                // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÂèñÂæóÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
                const urlParams = new URLSearchParams(window.location.search);
                const enemyKey = urlParams.get('enemy');
                if (enemyKey && window.pokemonDatabase && window.pokemonDatabase[enemyKey]) {
                    return enemyKey;
                }
                return 'eevee'; // „Éá„Éï„Ç©„É´„Éà
            };

            // ÂàùÊúü„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„ÅÆÊ∫ñÂÇôÔºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
            const initializePokemonData = () => {
                const initialData = {};

                // „Éó„É¨„Ç§„É§„ÉºÁî®„Ç§„É≥„Çπ„Çø„É≥„Çπ
                const playerPokemon = createPokemonInstance('pikachu', 'player');
                if (playerPokemon) {
                    initialData.playerInstance = playerPokemon;
                }

                // ÊïµÁî®„Ç§„É≥„Çπ„Çø„É≥„ÇπÔºàtransitionInfo„Åã„ÇâÂèñÂæó„ÄÅ„Å™„Åë„Çå„Å∞URL„Éë„É©„É°„Éº„Çø„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„ÉàÔºâ
                const enemyPokemonKey = getEnemyPokemonFromTransition();
                const enemyPokemon = createPokemonInstance(enemyPokemonKey, 'enemy');
                if (enemyPokemon) {
                    initialData.enemyInstance = enemyPokemon;
                    initialData.enemyPokemon = enemyPokemonKey;
                }

                return initialData;
            };

            // transitionInfo„Åã„ÇâÊÉÖÂ†±„ÇíÂèñÂæó
            const fromMap = transitionInfo ? transitionInfo.fromMap : null;
            const playerX = transitionInfo ? transitionInfo.playerX : null;
            const playerY = transitionInfo ? transitionInfo.playerY : null;
            const enemyParam = transitionInfo ? transitionInfo.enemyPokemon : null;
            const isWildPokemon = !!(fromMap && enemyParam); // „Éû„ÉÉ„Éó„Åã„ÇâÊù•„Å¶„ÄÅÊïµ„Éù„Ç±„É¢„É≥„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà

            // Áä∂ÊÖãÁÆ°ÁêÜ
            const [gameState, setGameState] = React.useState(() => {
                const pokemonData = initializePokemonData();
                return {
                    playerPokemon: "pikachu",
                    enemyPokemon: pokemonData.enemyPokemon || "eevee",
                    ...pokemonData,
                    currentTurn: "player",
                    battleLog: [],
                    isGameOver: false,
                    winner: null,
                    showPokemonSelector: false,
                    selectorMode: null, // "player" or "enemy"
                    showWinModal: false,
                    showEnrageModal: false,
                    fromMap: fromMap, // „Å©„ÅÆ„Éû„ÉÉ„Éó„Åã„ÇâÊù•„Åü„Åã
                    playerPosition: playerX && playerY ? { x: parseInt(playerX), y: parseInt(playerY) } : null,
                    isWildPokemon: isWildPokemon, // ÈáéÁîü„Éù„Ç±„É¢„É≥„Åã„Å©„ÅÜ„Åã
                    animationState: {
                        pikachuShake: false,
                        eeveeShake: false,
                        squirtleShake: false,
                        diglettShake: false,
                        pikachuFlash: false,
                        eeveeFlash: false,
                        squirtleFlash: false,
                        diglettFlash: false,
                        criticalHit: false,
                        battleMessage: "",
                        moveName: "",
                        moveType: ""
                    }
                };
            });

            // „Çø„Ç§„ÉóÁõ∏ÊÄß„ÉÅ„É£„Éº„ÉàÔºàÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            const typeEffectiveness = window.typeEffectiveness || {
                '„Åß„Çì„Åç': { '„Åø„Åö': 2.0, '„Åò„ÇÅ„Çì': 0.0, '„Éé„Éº„Éû„É´': 1.0, '„ÅØ„Åå„Å≠': 0.5 },
                '„Åø„Åö': { '„Åò„ÇÅ„Çì': 2.0, '„Åß„Çì„Åç': 0.5, '„Éé„Éº„Éû„É´': 1.0, '„ÅØ„Åå„Å≠': 1.0 },
                '„Åò„ÇÅ„Çì': { '„Åß„Çì„Åç': 2.0, '„Åø„Åö': 0.5, '„Éé„Éº„Éû„É´': 1.0, '„ÅØ„Åå„Å≠': 2.0 },
                '„ÅØ„Åå„Å≠': { '„Éé„Éº„Éû„É´': 1.2, '„Åß„Çì„Åç': 1.0, '„Åø„Åö': 1.0, '„Åò„ÇÅ„Çì': 0.5 },
                '„Éé„Éº„Éû„É´': { '„ÅØ„Åå„Å≠': 0.5, '„Åß„Çì„Åç': 1.0, '„Åø„Åö': 1.0, '„Åò„ÇÅ„Çì': 1.0 },
                '„Åã„Åè„Å®„ÅÜ': { '„Éé„Éº„Éû„É´': 2.0, '„ÅØ„Åå„Å≠': 2.0, '„Åß„Çì„Åç': 1.0, '„Åø„Åö': 1.0 }
            };

            // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÈñ¢Êï∞Ôºà„Çà„Çä„É™„Ç¢„É´Ôºâ
            const calculateDamage = (move, attacker, defender) => {
                // ÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ
                if (!move || !attacker || !defender) {
                    return { damage: 0, critical: false, effectiveness: 1.0, message: "miss" };
                }

                // ÂëΩ‰∏≠ÁéáÂà§ÂÆö
                const hitChance = Math.random() * 100;
                if (hitChance > move.accuracy) {
                    return { damage: 0, critical: false, effectiveness: 1.0, message: "miss" };
                }

                // „ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Éí„ÉÉ„ÉàÂà§ÂÆöÔºà6.25%Ôºâ
                const isCritical = Math.random() < 0.0625;
                const criticalMultiplier = isCritical ? 1.5 : 1.0;

                // Âü∫Êú¨„ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ‰ªò„ÅçÔºâ
                const attackStat = attacker.stats?.attack || 50;
                const defenseStat = defender.stats?.defense || 50;
                const baseDamage = Math.floor(((2 * 50 / 5 + 2) * move.power * attackStat / defenseStat) / 50 + 2);

                // „É©„É≥„ÉÄ„É†Ë¶ÅÁ¥†Ôºà0.85-1.0ÂÄçÔºâ
                const randomFactor = 0.85 + Math.random() * 0.15;
                let damage = Math.floor(baseDamage * randomFactor * criticalMultiplier);

                // „Çø„Ç§„ÉóÁõ∏ÊÄß
                const effectiveness = typeEffectiveness[move.type]?.[defender.type] ?? 1.0;
                damage = Math.floor(damage * effectiveness);

                // ÊúÄ‰Ωé1„ÉÄ„É°„Éº„Ç∏
                damage = Math.max(1, damage);

                return {
                    damage,
                    critical: isCritical,
                    effectiveness,
                    message: effectiveness > 1.0 ? "super_effective" : effectiveness < 1.0 ? "not_very_effective" : "normal"
                };
            };

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âà∂Âæ°Èñ¢Êï∞
            const triggerAnimation = (animationType, target, duration = 500) => {
                setGameState(prev => ({
                    ...prev,
                    animationState: {
                        ...prev.animationState,
                        [target]: true
                    }
                }));

                setTimeout(() => {
                    setGameState(prev => ({
                        ...prev,
                        animationState: {
                            ...prev.animationState,
                            [target]: false
                        }
                    }));
                }, duration);
            };

            // „Éê„Éà„É´„É≠„Ç∞ËøΩÂä†Èñ¢Êï∞
            const addToBattleLog = (message) => {
                setGameState(prev => ({
                    ...prev,
                    battleLog: [...prev.battleLog.slice(-4), message]
                }));
            };

            // „Å∏„Çì„Åó„ÇìÊäÄ„ÇíÂÆüË°å„Åô„ÇãÈñ¢Êï∞
            const performTransform = (attackerKey) => {
                const pokemonKeys = Object.keys(pokemonDatabase);
                const currentPokemon = getCurrentPokemon(attackerKey);
                const currentPokemonKey = gameState[attackerKey];

                // ÁèæÂú®„ÅÆ„Éù„Ç±„É¢„É≥‰ª•Â§ñ„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´ÈÅ∏Êäû
                const availablePokemon = pokemonKeys.filter(key => key !== currentPokemonKey);
                const randomPokemonKey = availablePokemon[Math.floor(Math.random() * availablePokemon.length)];
                const transformPokemon = pokemonDatabase[randomPokemonKey];

                if (!transformPokemon) {
                    addToBattleLog("„Å∏„Çì„Åó„Çì„Å´Â§±Êïó„Åó„ÅüÔºÅ");
                    return;
                }

                // ÁèæÂú®„ÅÆHP„Çí‰øùÊåÅÔºàÂÆâÂÖ®„Å´ÂèñÂæóÔºâ
                const currentHP = currentPokemon.currentHP || currentPokemon.maxHP || 100;

                // „Éù„Ç±„É¢„É≥„ÇíÂ§âÊõ¥ÔºàHP„ÅØ„Åù„ÅÆ„Åæ„Åæ„ÄÅÊäÄ„Å®PP„ÅØÊñ∞„Åó„ÅÑ„Éù„Ç±„É¢„É≥„ÅÆ„ÇÇ„ÅÆÔºâ
                setGameState(prev => {
                    // ÁèæÂú®„ÅÆ„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„ÇíÂèñÂæó
                    const attackerPokemonKey = prev[attackerKey];
                    const attackerPokemon = prev[attackerPokemonKey];

                    if (!attackerPokemon) {
                        console.error(`Attacker pokemon not found: ${attackerPokemonKey}`);
                        return prev;
                    }

                    // Êñ∞„Åó„ÅÑ„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„Çí‰ΩúÊàêÔºàHP„ÅØÁèæÂú®„ÅÆHP„Çí‰øùÊåÅÔºâ
                    const newPokemonData = {
                        ...transformPokemon,
                        currentHP: currentHP, // ÁèæÂú®„ÅÆHP„Çí‰øùÊåÅ
                        status: null,
                        pp: transformPokemon.moves.reduce((acc, move, index) => {
                            acc[index] = move.pp;
                            return acc;
                        }, {})
                    };

                    // Êñ∞„Åó„ÅÑÁä∂ÊÖã„Çí‰ΩúÊàêÔºàÊó¢Â≠ò„ÅÆ„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„Çí‰øùÊåÅ„Åó„ÄÅÊñ∞„Åó„ÅÑ„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„ÅÆ„ÅøËøΩÂä†Ôºâ
                    const newState = {
                        ...prev,
                        [attackerKey]: randomPokemonKey,
                        battleLog: [
                            ...prev.battleLog.slice(-4),
                            `${currentPokemon.name}„ÅØ${transformPokemon.name}„Å´„Å∏„Çì„Åó„Çì„Åó„ÅüÔºÅ`
                        ]
                    };

                    // Êñ∞„Åó„ÅÑ„Éù„Ç±„É¢„É≥„Éá„Éº„Çø„ÇíËøΩÂä†ÔºàÊó¢Â≠ò„ÅÆ„Éá„Éº„Çø„Çí‰∏äÊõ∏„Åç„Åó„Å™„ÅÑÔºâ
                    newState[randomPokemonKey] = newPokemonData;

                    // „Éê„Éà„É´„É≠„Ç∞„Å´ËøΩÂä†
                    setTimeout(() => {
                        addToBattleLog(`${transformPokemon.name}„ÅÆÊäÄ„Å´Â§â„Çè„Å£„ÅüÔºÅ`);
                    }, 100);

                    return newState;
                });
            };

            // ÊîªÊíÉÂá¶ÁêÜÈñ¢Êï∞Ôºà„Çà„Çä„É™„Ç¢„É´Ôºâ
            const performAttack = (attackerKey, defenderKey, moveIndex) => {
                if (gameState.isGameOver) return;

                const attacker = getCurrentPokemon(attackerKey);
                const defender = getCurrentPokemon(defenderKey);
                const move = attacker.moves[moveIndex];

                // PP„ÉÅ„Çß„ÉÉ„ÇØ
                if (attacker.pp[moveIndex] <= 0) {
                    addToBattleLog(`${attacker.name}„ÅÆ${move.name}„ÅÆPP„ÅåË∂≥„Çä„Å™„ÅÑÔºÅ`);
                    return;
                }

                // „Å∏„Çì„Åó„ÇìÊäÄ„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (move.name === "„Å∏„Çì„Åó„Çì") {
                    // PP„ÇíÊ∏õ„Çâ„Åô
                    setGameState(prev => {
                        const attackerPokemonKey = prev[attackerKey];
                        const attackerPokemon = prev[attackerPokemonKey];

                        if (!attackerPokemon || !attackerPokemon.pp) {
                            console.error(`Attacker pokemon not found: ${attackerPokemonKey}`);
                            return prev;
                        }

                        return {
                            ...prev,
                            [attackerPokemonKey]: {
                                ...attackerPokemon,
                                pp: {
                                    ...attackerPokemon.pp,
                                    [moveIndex]: attackerPokemon.pp[moveIndex] - 1
                                }
                            }
                        };
                    });

                    // „Å∏„Çì„Åó„Çì„ÇíÂÆüË°å
                    performTransform(attackerKey);

                    // „Çø„Éº„É≥ÁµÇ‰∫Ü
                    setGameState(prev => ({
                        ...prev,
                        currentTurn: prev.currentTurn === "player" ? "enemy" : "player"
                    }));
                    return;
                }

                // „Éñ„ÉÅ„ÇÆ„É¨„ÇãÊäÄ„ÅÆÁâπÂà•Âá¶ÁêÜ
                if (move.name === "„Éñ„ÉÅ„ÇÆ„É¨„Çã") {
                    // „Éê„Éà„É´„É≠„Ç∞Êõ¥Êñ∞
                    addToBattleLog(`${attacker.name}„ÅÆ${move.name}ÔºÅ`);

                    // ÊäÄÂêç„ÇíÁîªÈù¢„Å´Â§ß„Åç„ÅèË°®Á§∫
                    setGameState(prev => ({
                        ...prev,
                        animationState: {
                            ...prev.animationState,
                            moveName: move.name,
                            moveType: move.type
                        }
                    }));

                    setTimeout(() => {
                        setGameState(prev => ({
                            ...prev,
                            animationState: {
                                ...prev.animationState,
                                moveName: "",
                                moveType: ""
                            }
                        }));
                    }, 1500);

                    // PP„ÇíÊ∏õ„Çâ„ÅôÔºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
                    setGameState(prev => {
                        if (attackerKey === "playerPokemon") {
                            const attackerPokemon = prev.playerInstance;
                            if (!attackerPokemon || !attackerPokemon.pp) {
                                console.error(`Player pokemon not found`);
                                return prev;
                            }
                            return {
                                ...prev,
                                playerInstance: {
                                    ...attackerPokemon,
                                    pp: {
                                        ...attackerPokemon.pp,
                                        [moveIndex]: attackerPokemon.pp[moveIndex] - 1
                                    }
                                }
                            };
                        } else if (attackerKey === "enemyPokemon") {
                            const attackerPokemon = prev.enemyInstance;
                            if (!attackerPokemon || !attackerPokemon.pp) {
                                console.error(`Enemy pokemon not found`);
                                return prev;
                            }
                            return {
                                ...prev,
                                enemyInstance: {
                                    ...attackerPokemon,
                                    pp: {
                                        ...attackerPokemon.pp,
                                        [moveIndex]: attackerPokemon.pp[moveIndex] - 1
                                    }
                                }
                            };
                        }
                        return prev;
                    });

                    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                    setTimeout(() => {
                        setGameState(prev => ({ ...prev, showEnrageModal: true }));
                    }, 300);

                    // 1.5ÁßíÂæå„Å´„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Å¶Â§âË∫´
                    setTimeout(() => {
                        setGameState(prev => {
                            const currentHP = attacker.currentHP || attacker.maxHP || 170;
                            const enragedPokemon = pokemonDatabase['angrymasterenraged'];

                            if (!enragedPokemon) {
                                return { ...prev, showEnrageModal: false };
                            }

                            const newPokemonData = {
                                ...enragedPokemon,
                                currentHP: currentHP,
                                status: null,
                                pp: enragedPokemon.moves.reduce((acc, move, index) => {
                                    acc[index] = move.pp;
                                    return acc;
                                }, {})
                            };

                            const newState = {
                                ...prev,
                                [attackerKey]: 'angrymasterenraged',
                                showEnrageModal: false,
                                battleLog: [
                                    ...prev.battleLog.slice(-4),
                                    `${attacker.name}„Åå„Éñ„ÉÅ„ÇÆ„É¨„ÅüÔºÅ`,
                                    `ÊîªÊíÉÂäõ„Åå‰∏äÊòá„Åó„ÅüÔºÅ`
                                ]
                            };

                            // „Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøú
                            if (attackerKey === "playerPokemon") {
                                newState.playerInstance = newPokemonData;
                            } else if (attackerKey === "enemyPokemon") {
                                newState.enemyInstance = newPokemonData;
                            }

                            return newState;
                        });
                    }, 1800);

                    // „Çø„Éº„É≥ÁµÇ‰∫Ü
                    setTimeout(() => {
                        setGameState(prev => ({
                            ...prev,
                            currentTurn: prev.currentTurn === "player" ? "enemy" : "player"
                        }));
                    }, 1900);
                    return;
                }

                const result = calculateDamage(move, attacker, defender);

                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
                const attackerAnimationTarget = `${attackerKey}Flash`;
                triggerAnimation("flash", attackerAnimationTarget, 300);

                // PPÊ∂àË≤ªÔºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
                setGameState(prev => {
                    if (attackerKey === "playerPokemon") {
                        const attackerPokemon = prev.playerInstance;
                        if (!attackerPokemon || !attackerPokemon.pp) {
                            console.error(`Player pokemon not found`);
                            return prev;
                        }
                        return {
                            ...prev,
                            playerInstance: {
                                ...attackerPokemon,
                                pp: {
                                    ...attackerPokemon.pp,
                                    [moveIndex]: attackerPokemon.pp[moveIndex] - 1
                                }
                            }
                        };
                    } else if (attackerKey === "enemyPokemon") {
                        const attackerPokemon = prev.enemyInstance;
                        if (!attackerPokemon || !attackerPokemon.pp) {
                            console.error(`Enemy pokemon not found`);
                            return prev;
                        }
                        return {
                            ...prev,
                            enemyInstance: {
                                ...attackerPokemon,
                                pp: {
                                    ...attackerPokemon.pp,
                                    [moveIndex]: attackerPokemon.pp[moveIndex] - 1
                                }
                            }
                        };
                    }
                    return prev;
                });

                // „Éê„Éà„É´„É≠„Ç∞Êõ¥Êñ∞
                addToBattleLog(`${attacker.name}„ÅÆ${move.name}ÔºÅ`);

                // ÊäÄÂêç„ÇíÁîªÈù¢„Å´Â§ß„Åç„ÅèË°®Á§∫
                setGameState(prev => ({
                    ...prev,
                    animationState: {
                        ...prev.animationState,
                        moveName: move.name,
                        moveType: move.type
                    }
                }));

                setTimeout(() => {
                    setGameState(prev => ({
                        ...prev,
                        animationState: {
                            ...prev.animationState,
                            moveName: "",
                            moveType: ""
                        }
                    }));
                }, 1500);

                if (result.message === "miss") {
                    addToBattleLog(`${attacker.name}„ÅÆÊîªÊíÉ„ÅØÂ§ñ„Çå„ÅüÔºÅ`);
                    // ÊîªÊíÉÂ§ñ„ÇåÂäπÊûúÈü≥ÔºàWeb Audio APIÔºâ
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);

                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (error) {
                        console.log('Miss sound error:', error);
                    }
                    // ÊîªÊíÉÂ§ñ„Çå„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                    setGameState(prev => ({
                        ...prev,
                        animationState: {
                            ...prev.animationState,
                            battleMessage: "MISS!"
                        }
                    }));

                    setTimeout(() => {
                        setGameState(prev => ({
                            ...prev,
                            animationState: {
                                ...prev.animationState,
                                battleMessage: ""
                            }
                        }));
                    }, 2000);

                    setGameState(prev => ({
                        ...prev,
                        currentTurn: prev.currentTurn === "player" ? "enemy" : "player"
                    }));
                    return;
                }

                const newDefenderHP = Math.max(0, defender.currentHP - result.damage);
                const defenderAnimationTarget = `${defenderKey}Shake`;

                setTimeout(() => {
                    triggerAnimation("shake", defenderAnimationTarget, 500);
                }, 200);

                // ÂäπÊûú„É°„ÉÉ„Çª„Éº„Ç∏„Å®ÂäπÊûúÈü≥
                if (result.critical) {
                    addToBattleLog("„ÇØ„É™„ÉÜ„Ç£„Ç´„É´„Éí„ÉÉ„ÉàÔºÅ");
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.type = 'sine';
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);

                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (error) {
                        console.log('Critical sound error:', error);
                    }
                }

                if (result.message === "super_effective") {
                    addToBattleLog("ÂäπÊûú„ÅØÊäúÁæ§„Å†ÔºÅ");
                } else if (result.message === "not_very_effective") {
                    addToBattleLog("ÂäπÊûú„ÅØ‰ªä„Å≤„Å®„Å§...");
                }

                // ÊîªÊíÉÂäπÊûúÈü≥
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (error) {
                    console.log('Attack sound error:', error);
                }

                addToBattleLog(`${defender.name}„Å´${result.damage}„ÉÄ„É°„Éº„Ç∏ÔºÅ`);

                // HPÊõ¥Êñ∞„Å®„Ç≤„Éº„É†Áä∂ÊÖãÊõ¥Êñ∞Ôºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
                setGameState(prev => {
                    let newState = { ...prev };

                    if (defenderKey === "playerPokemon") {
                        const defenderPokemon = prev.playerInstance;
                        if (!defenderPokemon) {
                            console.error(`Player pokemon not found`);
                            return prev;
                        }
                        newState.playerInstance = {
                            ...defenderPokemon,
                            currentHP: newDefenderHP
                        };
                    } else if (defenderKey === "enemyPokemon") {
                        const defenderPokemon = prev.enemyInstance;
                        if (!defenderPokemon) {
                            console.error(`Enemy pokemon not found`);
                            return prev;
                        }
                        newState.enemyInstance = {
                            ...defenderPokemon,
                            currentHP: newDefenderHP
                        };
                    }

                    if (newDefenderHP <= 0) {
                        newState.isGameOver = true;
                        // ÂãùËÄÖ„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö
                        newState.winner = attackerKey === "playerPokemon" ? "player" : "enemy";
                        // ÂãùÂà©ÂäπÊûúÈü≥
                        try {
                            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                            // ÂãùÂà©„Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
                            const createNote = (freq, time, duration) => {
                                const oscillator = audioContext.createOscillator();
                                const gainNode = audioContext.createGain();

                                oscillator.connect(gainNode);
                                gainNode.connect(audioContext.destination);

                                oscillator.type = 'sine';
                                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime + time);

                                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + time);
                                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + time + duration);

                                oscillator.start(audioContext.currentTime + time);
                                oscillator.stop(audioContext.currentTime + time + duration);
                            };

                            createNote(523, 0, 0.2);    // C5
                            createNote(659, 0.2, 0.2);  // E5
                            createNote(784, 0.4, 0.4);  // G5
                        } catch (error) {
                            console.log('Victory sound error:', error);
                        }
                        setTimeout(() => {
                            addToBattleLog(`${defender.name}„ÅØÂÄí„Çå„ÅüÔºÅ`);
                            addToBattleLog(`${attacker.name}„ÅÆÂãùÂà©ÔºÅ`);
                        }, 300);
                        // ÂãùÂà©„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                        setTimeout(() => {
                            setGameState(prevState => ({ ...prevState, showWinModal: true }));
                        }, 800);
                    } else {
                        newState.currentTurn = prev.currentTurn === "player" ? "enemy" : "player";
                    }

                    return newState;
                });
            };

            // „Éó„É¨„Ç§„É§„ÉºÊîªÊíÉÈñ¢Êï∞
            const playerAttack = (moveIndex) => {
                if (gameState.currentTurn === "player" && !gameState.isGameOver) {
                    performAttack("playerPokemon", "enemyPokemon", moveIndex);
                }
            };

            // ÊïµAIÊîªÊíÉÈñ¢Êï∞Ôºà„Çà„ÇäË≥¢„ÅÑAIÔºâ
            const enemyAttack = () => {
                if (gameState.currentTurn === "enemy" && !gameState.isGameOver) {
                    const enemyPokemon = getCurrentPokemon("enemyPokemon");
                    const playerPokemon = getCurrentPokemon("playerPokemon");

                    // Âà©Áî®ÂèØËÉΩ„Å™ÊäÄ„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                    const availableMoves = enemyPokemon.moves.map((move, index) => ({
                        ...move,
                        index,
                        pp: enemyPokemon.pp[index]
                    })).filter(move => move.pp > 0);

                    if (availableMoves.length === 0) {
                        addToBattleLog(`${enemyPokemon.name}„ÅØÊäÄ„Çí‰Ωø„Åà„Å™„ÅÑÔºÅ`);
                        setGameState(prev => ({
                            ...prev,
                            currentTurn: "player"
                        }));
                        return;
                    }

                    // „Çø„Ç§„ÉóÁõ∏ÊÄß„ÇíËÄÉÊÖÆ„Åó„ÅüÊäÄÈÅ∏Êäû
                    let bestMove = availableMoves[0];
                    let bestScore = 0;

                    availableMoves.forEach(move => {
                        const effectiveness = typeEffectiveness[move.type]?.[playerPokemon.type] ?? 1.0;
                        const score = move.power * effectiveness;
                        if (score > bestScore) {
                            bestScore = score;
                            bestMove = move;
                        }
                    });

                    setTimeout(() => {
                        performAttack("enemyPokemon", "playerPokemon", bestMove.index);
                    }, 1500);
                }
            };

            // Êïµ„ÅÆ„Çø„Éº„É≥Ëá™ÂãïÂÆüË°å
            React.useEffect(() => {
                if (gameState.currentTurn === "enemy" && !gameState.isGameOver) {
                    enemyAttack();
                }
            }, [gameState.currentTurn]);

            // „Éù„Ç±„É¢„É≥ÈÅ∏ÊäûÈñ¢Êï∞Ôºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
            const selectPokemon = (pokemonKey) => {
                setGameState(prev => {
                    const newState = { ...prev };

                    if (prev.selectorMode === "player") {
                        newState.playerPokemon = pokemonKey;
                        newState.playerInstance = createPokemonInstance(pokemonKey, 'player');
                    } else if (prev.selectorMode === "enemy") {
                        newState.enemyPokemon = pokemonKey;
                        newState.enemyInstance = createPokemonInstance(pokemonKey, 'enemy');
                    }

                    newState.showPokemonSelector = false;
                    newState.selectorMode = null;
                    return newState;
                });
            };

            // „Ç≤„Éº„É†„É™„Çª„ÉÉ„ÉàÈñ¢Êï∞
            const resetGame = () => {
                setGameState(prev => {
                    // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éù„Ç±„É¢„É≥„Çí‰øùÊåÅ„Åó„Å¶„É™„Çª„ÉÉ„Éà
                    const currentPlayerPokemon = prev.playerPokemon;
                    const currentEnemyPokemon = prev.enemyPokemon;

                    // ÁèæÂú®„ÅÆ„Éù„Ç±„É¢„É≥„ÅßÊñ∞„Åó„ÅÑ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰ΩúÊàê
                    const playerInstance = createPokemonInstance(currentPlayerPokemon, 'player');
                    const enemyInstance = createPokemonInstance(currentEnemyPokemon, 'enemy');

                    return {
                        ...prev,
                        playerInstance: playerInstance,
                        enemyInstance: enemyInstance,
                        currentTurn: "player",
                        battleLog: ["„Éê„Éà„É´ÈñãÂßãÔºÅ"],
                        isGameOver: false,
                        winner: null,
                        showWinModal: false,
                        showEnrageModal: false,
                        animationState: {
                            pikachuShake: false,
                            eeveeShake: false,
                            squirtleShake: false,
                            diglettShake: false,
                            pikachuFlash: false,
                            eeveeFlash: false,
                            squirtleFlash: false,
                            diglettFlash: false,
                            criticalHit: false,
                            battleMessage: "",
                            moveName: "",
                            moveType: ""
                        }
                    };
                });
            };

            // ÂàùÊúüÂåñ
            React.useEffect(() => {
                // „Éù„Ç±„É¢„É≥„Éá„Éº„Çø„Éô„Éº„Çπ„ÅåË™≠„ÅøËæº„Åæ„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
                if (window.pokemonDatabase && Object.keys(window.pokemonDatabase).length > 0) {
                    resetGame();
                } else {
                    // „Éá„Éº„Çø„Éô„Éº„Çπ„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂ∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å
                    const timer = setTimeout(() => {
                        if (window.pokemonDatabase && Object.keys(window.pokemonDatabase).length > 0) {
                            resetGame();
                        }
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, []);

            // HP„Éê„Éº„ÅÆËâ≤„ÇíÊ±∫ÂÆö„Åô„ÇãÈñ¢Êï∞
            const getHPBarColor = (currentHP, maxHP) => {
                const percentage = (currentHP / maxHP) * 100;
                if (percentage > 60) return 'bg-green-500';
                if (percentage > 30) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            // ÊäÄ„Çø„Ç§„ÉóÂà•„ÅÆËâ≤„ÇíÊ±∫ÂÆö„Åô„ÇãÈñ¢Êï∞ÔºàÂ§ñÈÉ®„Éï„Ç°„Ç§„É´„Åã„ÇâË™≠„ÅøËæº„ÅøÔºâ
            const getMoveTypeColor = (type) => {
                const colors = window.typeColors || {
                    '„Åß„Çì„Åç': 'bg-yellow-400 hover:bg-yellow-500',
                    '„ÅØ„Åå„Å≠': 'bg-gray-400 hover:bg-gray-500',
                    '„Éé„Éº„Éû„É´': 'bg-gray-300 hover:bg-gray-400 text-gray-800',
                    '„Åò„ÇÅ„Çì': 'bg-amber-600 hover:bg-amber-700',
                    '„Åã„Åè„Å®„ÅÜ': 'bg-red-600 hover:bg-red-700',
                    '„Åø„Åö': 'bg-blue-500 hover:bg-blue-600',
                    '„Åª„ÅÆ„Åä': 'bg-red-500 hover:bg-red-600',
                    '„Ç®„Çπ„Éë„Éº': 'bg-purple-500 hover:bg-purple-600',
                    '„Åè„Åï': 'bg-green-500 hover:bg-green-600',
                    '„Åì„Åä„Çä': 'bg-cyan-300 hover:bg-cyan-400 text-black',
                    '„Å©„Åè': 'bg-purple-600 hover:bg-purple-700',
                    '„Å≤„Åì„ÅÜ': 'bg-indigo-400 hover:bg-indigo-500',
                    '„ÇÄ„Åó': 'bg-lime-500 hover:bg-lime-600',
                    '„ÅÑ„Çè': 'bg-stone-500 hover:bg-stone-600',
                    '„Ç¥„Éº„Çπ„Éà': 'bg-violet-600 hover:bg-violet-700',
                    '„Éâ„É©„Ç¥„É≥': 'bg-indigo-600 hover:bg-indigo-700',
                    '„ÅÇ„Åè': 'bg-gray-800 hover:bg-gray-900',
                    '„Éï„Çß„Ç¢„É™„Éº': 'bg-pink-300 hover:bg-pink-400 text-black'
                };
                return colors[type] || 'bg-blue-500 hover:bg-blue-600';
            };

            // ÁèæÂú®„ÅÆ„Éù„Ç±„É¢„É≥„ÇíÂèñÂæóÔºà„Ç§„É≥„Çπ„Çø„É≥„ÇπÁÆ°ÁêÜÂØæÂøúÔºâ
            const getCurrentPokemon = (key) => {
                if (key === "playerPokemon") {
                    return gameState.playerInstance || {
                        name: "„Éî„Ç´„ÉÅ„É•„Ç¶",
                        maxHP: 100,
                        currentHP: 100,
                        type: "„Åß„Çì„Åç",
                        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png",
                        moves: [
                            { name: "„Åß„Çì„Åç„Ç∑„Éß„ÉÉ„ÇØ", power: 40, type: "„Åß„Çì„Åç", accuracy: 100, pp: 30 },
                            { name: "„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã", power: 40, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                            { name: "10„Åæ„Çì„Éú„É´„Éà", power: 90, type: "„Åß„Çì„Åç", accuracy: 100, pp: 15 },
                            { name: "„Åã„Åø„Å™„Çä", power: 110, type: "„Åß„Çì„Åç", accuracy: 70, pp: 10 }
                        ],
                        stats: { attack: 55, defense: 40, speed: 90, special: 50 },
                        pp: { 0: 30, 1: 30, 2: 15, 3: 10 }
                    };
                } else if (key === "enemyPokemon") {
                    return gameState.enemyInstance || {
                        name: "„Ç§„Éº„Éñ„Ç§",
                        maxHP: 100,
                        currentHP: 100,
                        type: "„Éé„Éº„Éû„É´",
                        image: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/133.png",
                        moves: [
                            { name: "„Åß„Çì„Åì„ÅÜ„Åõ„Å£„Åã", power: 40, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                            { name: "„Åó„Å£„ÅΩ„Çí„Åµ„Çã", power: 0, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 30 },
                            { name: "„Å®„Å£„Åó„Çì", power: 90, type: "„Éé„Éº„Éû„É´", accuracy: 85, pp: 20 },
                            { name: "„ÅØ„Å≠„Çã", power: 0, type: "„Éé„Éº„Éû„É´", accuracy: 100, pp: 40 }
                        ],
                        stats: { attack: 55, defense: 50, speed: 55, special: 45 },
                        pp: { 0: 30, 1: 30, 2: 20, 3: 40 }
                    };
                }

                // HP„ÅÆÊï¥ÂêàÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const pokemon = gameState[key];
                if (pokemon && (pokemon.currentHP === undefined || pokemon.currentHP < 0)) {
                    pokemon.currentHP = pokemon.maxHP || 100;
                }

                return pokemon;
            };

            // UI „É¨„É≥„ÉÄ„É™„É≥„Ç∞
            return React.createElement('div', {
                className: 'min-h-screen battle-field p-4'
            }, [
                // „Éò„ÉÉ„ÉÄ„Éº
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center mb-6'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg'
                    }, '„Éù„Ç±„É¢„É≥„Éê„Éà„É´Ôºö„É™„Ç¢„É´„Éê„Éº„Ç∏„Éß„É≥'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg text-white drop-shadow-md'
                    }, `${getCurrentPokemon('playerPokemon').name} vs ${getCurrentPokemon('enemyPokemon').name}`),
                    // BGMÂà∂Âæ°
                    React.createElement('div', {
                        key: 'bgm-controls',
                        className: 'flex justify-center items-center gap-4 mt-4'
                    }, [
                        React.createElement('button', {
                            key: 'toggle-bgm',
                            onClick: toggleBGM,
                            className: `px-4 py-2 rounded-lg font-bold transition-all duration-200 ${bgmState.isPlaying
                                ? 'bg-red-600 hover:bg-red-700 text-white'
                                : 'bg-green-600 hover:bg-green-700 text-white'
                                }`
                        }, bgmState.isPlaying ? 'üîá BGMÂÅúÊ≠¢' : 'üîä BGMÈñãÂßã'),
                        React.createElement('div', {
                            key: 'player-status',
                            className: 'text-white text-xs'
                        }, window.youtubePlayerReady ? 'YouTubeÊ∫ñÂÇôÂÆå‰∫Ü' : 'YouTubeË™≠„ÅøËæº„Åø‰∏≠...'),
                        React.createElement('div', {
                            key: 'volume-control',
                            className: 'flex items-center gap-2'
                        }, [
                            React.createElement('span', {
                                key: 'volume-label',
                                className: 'text-white text-sm'
                            }, 'Èü≥Èáè:'),
                            React.createElement('input', {
                                key: 'volume-slider',
                                type: 'range',
                                min: '0',
                                max: '1',
                                step: '0.1',
                                value: bgmState.volume,
                                onChange: (e) => adjustVolume(parseFloat(e.target.value)),
                                className: 'w-24'
                            })
                        ]),
                        React.createElement('div', {
                            key: 'audio-hint',
                            className: 'text-white text-xs opacity-70'
                        }, 'BGM')
                    ])
                ]),

                // „É°„Ç§„É≥„Éê„Éà„É´„Ç®„É™„Ç¢
                React.createElement('div', {
                    key: 'battle-area',
                    className: 'max-w-6xl mx-auto bg-white/10 backdrop-blur-sm rounded-xl p-6 shadow-2xl'
                }, [
                    // „Éù„Ç±„É¢„É≥Ë°®Á§∫„Ç®„É™„Ç¢
                    React.createElement('div', {
                        key: 'pokemon-area',
                        className: 'grid md:grid-cols-2 gap-8 mb-8'
                    }, [
                        // „Éó„É¨„Ç§„É§„Éº„Éù„Ç±„É¢„É≥
                        React.createElement('div', {
                            key: 'player-section',
                            className: `text-center slide-in ${gameState.animationState[`${gameState.playerPokemon}Shake`] ? 'shake' : ''} ${gameState.animationState[`${gameState.playerPokemon}Flash`] ? 'flash' : ''}`
                        }, [
                            React.createElement('div', {
                                key: 'player-header',
                                className: 'flex justify-between items-center mb-4'
                            }, [
                                React.createElement('h2', {
                                    key: 'player-name',
                                    className: 'text-2xl font-bold text-yellow-400'
                                }, `${getCurrentPokemon('playerPokemon').name} („Éó„É¨„Ç§„É§„Éº)`),
                                React.createElement('button', {
                                    key: 'change-player',
                                    onClick: () => setGameState(prev => ({ ...prev, showPokemonSelector: true, selectorMode: "player" })),
                                    className: 'bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm'
                                }, 'Â§âÊõ¥')
                            ]),
                            React.createElement('div', {
                                key: 'player-type',
                                className: 'inline-block bg-yellow-500 text-black px-3 py-1 rounded-full text-sm font-bold mb-4'
                            }, getCurrentPokemon('playerPokemon').type + '„Çø„Ç§„Éó'),
                            React.createElement('img', {
                                key: 'player-image',
                                src: getCurrentPokemon('playerPokemon').image,
                                alt: getCurrentPokemon('playerPokemon').name,
                                className: 'w-32 h-32 mx-auto mb-4 bounce',
                                style: { imageRendering: 'pixelated' }
                            }),
                            // HPË°®Á§∫
                            React.createElement('div', {
                                key: 'player-hp',
                                className: 'mb-4'
                            }, [
                                React.createElement('div', {
                                    key: 'player-hp-text',
                                    className: 'text-white font-bold mb-2'
                                }, `HP: ${getCurrentPokemon('playerPokemon').currentHP}/${getCurrentPokemon('playerPokemon').maxHP}`),
                                React.createElement('div', {
                                    key: 'player-hp-bar-bg',
                                    className: 'w-full bg-gray-700 rounded-full h-4'
                                }, React.createElement('div', {
                                    key: 'player-hp-bar',
                                    className: `hp-bar h-4 rounded-full transition-all duration-500 ${getHPBarColor(getCurrentPokemon('playerPokemon').currentHP, getCurrentPokemon('playerPokemon').maxHP)}`,
                                    style: { width: `${(getCurrentPokemon('playerPokemon').currentHP / getCurrentPokemon('playerPokemon').maxHP) * 100}%` }
                                }))
                            ])
                        ]),

                        // Êïµ„Éù„Ç±„É¢„É≥
                        React.createElement('div', {
                            key: 'enemy-section',
                            className: `text-center slide-in-right ${gameState.animationState[`${gameState.enemyPokemon}Shake`] ? 'shake' : ''} ${gameState.animationState[`${gameState.enemyPokemon}Flash`] ? 'flash' : ''}`
                        }, [
                            React.createElement('div', {
                                key: 'enemy-header',
                                className: 'flex justify-between items-center mb-4'
                            }, [
                                React.createElement('h2', {
                                    key: 'enemy-name',
                                    className: 'text-2xl font-bold text-amber-400'
                                }, `${getCurrentPokemon('enemyPokemon').name} (CPU)`),
                                React.createElement('button', {
                                    key: 'change-enemy',
                                    onClick: () => setGameState(prev => ({ ...prev, showPokemonSelector: true, selectorMode: "enemy" })),
                                    className: 'bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm'
                                }, 'Â§âÊõ¥')
                            ]),
                            React.createElement('div', {
                                key: 'enemy-type',
                                className: 'inline-block bg-gray-500 text-white px-3 py-1 rounded-full text-sm font-bold mb-4'
                            }, getCurrentPokemon('enemyPokemon').type + '„Çø„Ç§„Éó'),
                            React.createElement('img', {
                                key: 'enemy-image',
                                src: getCurrentPokemon('enemyPokemon').image,
                                alt: getCurrentPokemon('enemyPokemon').name,
                                className: 'w-32 h-32 mx-auto mb-4 bounce',
                                style: { imageRendering: 'pixelated' }
                            }),
                            // HPË°®Á§∫
                            React.createElement('div', {
                                key: 'enemy-hp',
                                className: 'mb-4'
                            }, [
                                React.createElement('div', {
                                    key: 'enemy-hp-text',
                                    className: 'text-white font-bold mb-2'
                                }, `HP: ${getCurrentPokemon('enemyPokemon').currentHP}/${getCurrentPokemon('enemyPokemon').maxHP}`),
                                React.createElement('div', {
                                    key: 'enemy-hp-bar-bg',
                                    className: 'w-full bg-gray-700 rounded-full h-4'
                                }, React.createElement('div', {
                                    key: 'enemy-hp-bar',
                                    className: `hp-bar h-4 rounded-full transition-all duration-500 ${getHPBarColor(getCurrentPokemon('enemyPokemon').currentHP, getCurrentPokemon('enemyPokemon').maxHP)}`,
                                    style: { width: `${(getCurrentPokemon('enemyPokemon').currentHP / getCurrentPokemon('enemyPokemon').maxHP) * 100}%` }
                                }))
                            ])
                        ])
                    ]),

                    // „Çø„Éº„É≥Ë°®Á§∫
                    React.createElement('div', {
                        key: 'turn-indicator',
                        className: 'text-center mb-6'
                    }, [
                        React.createElement('div', {
                            key: 'turn-text',
                            className: `inline-block px-6 py-3 rounded-full font-bold text-lg ${gameState.isGameOver
                                ? 'bg-purple-600 text-white'
                                : gameState.currentTurn === 'player'
                                    ? 'bg-blue-600 text-white glow'
                                    : 'bg-red-600 text-white'
                                }`
                        }, gameState.isGameOver
                            ? `„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ${gameState.winner === 'player' ? getCurrentPokemon('playerPokemon').name : getCurrentPokemon('enemyPokemon').name}„ÅÆÂãùÂà©ÔºÅ`
                            : gameState.currentTurn === 'player'
                                ? '„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥'
                                : 'CPU„ÅÆ„Çø„Éº„É≥'),
                        // ÊîªÊíÉÂ§ñ„Çå„É°„ÉÉ„Çª„Éº„Ç∏
                        gameState.animationState.battleMessage && React.createElement('div', {
                            key: 'miss-message',
                            className: `miss-animation fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 text-6xl font-bold text-red-500 drop-shadow-2xl bg-black/50 px-8 py-4 rounded-lg`
                        }, gameState.animationState.battleMessage),
                        // ÊäÄÂêçË°®Á§∫
                        gameState.animationState.moveName && React.createElement('div', {
                            key: 'move-name-display',
                            className: `move-name-display fixed top-1/3 left-1/2 z-50 px-12 py-8 rounded-2xl shadow-2xl border-4 text-center`,
                            style: {
                                background: 'linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(20,20,20,0.95) 100%)',
                                borderColor: getMoveTypeColor(gameState.animationState.moveType).includes('yellow') ? '#FCD34D' :
                                    getMoveTypeColor(gameState.animationState.moveType).includes('blue') ? '#60A5FA' :
                                        getMoveTypeColor(gameState.animationState.moveType).includes('red') ? '#F87171' :
                                            getMoveTypeColor(gameState.animationState.moveType).includes('green') ? '#4ADE80' :
                                                getMoveTypeColor(gameState.animationState.moveType).includes('purple') ? '#C084FC' :
                                                    getMoveTypeColor(gameState.animationState.moveType).includes('gray') ? '#9CA3AF' : '#FCD34D'
                            }
                        }, [
                            React.createElement('div', {
                                key: 'move-type-badge',
                                className: `inline-block ${getMoveTypeColor(gameState.animationState.moveType)} px-4 py-2 rounded-full text-sm font-bold mb-3 text-center`
                            }, gameState.animationState.moveType + '„Çø„Ç§„Éó'),
                            React.createElement('div', {
                                key: 'move-name-text',
                                className: 'text-6xl font-black text-white drop-shadow-2xl text-center',
                                style: { textShadow: '0 5px 15px rgba(0,0,0,0.8)' }
                            }, gameState.animationState.moveName)
                        ])
                    ]),

                    // ÊäÄÈÅ∏Êäû„Éú„Çø„É≥
                    !gameState.isGameOver && gameState.currentTurn === 'player' && React.createElement('div', {
                        key: 'move-buttons',
                        className: 'grid grid-cols-2 gap-4 mb-6'
                    }, getCurrentPokemon('playerPokemon').moves.map((move, index) =>
                        React.createElement('button', {
                            key: `move-${index}`,
                            onClick: () => playerAttack(index),
                            disabled: getCurrentPokemon('playerPokemon').pp[index] <= 0,
                            className: `p-4 rounded-lg font-bold text-white transition-all duration-200 transform hover:scale-105 active:scale-95 ${getMoveTypeColor(move.type)} ${getCurrentPokemon('playerPokemon').pp[index] <= 0 ? 'opacity-50 cursor-not-allowed' : ''}`
                        }, [
                            React.createElement('div', {
                                key: 'move-name',
                                className: 'text-lg'
                            }, move.name),
                            React.createElement('div', {
                                key: 'move-details',
                                className: 'text-sm opacity-80'
                            }, `${move.type}„Çø„Ç§„Éó„ÉªÂ®ÅÂäõ${move.power}„ÉªÂëΩ‰∏≠${move.accuracy}%`),
                            React.createElement('div', {
                                key: 'move-pp',
                                className: 'text-xs opacity-60'
                            }, `PP: ${getCurrentPokemon('playerPokemon').pp[index]}/${move.pp}`)
                        ])
                    )),

                    // „Éê„Éà„É´„É≠„Ç∞
                    React.createElement('div', {
                        key: 'battle-log',
                        className: 'bg-black/50 rounded-lg p-4 h-32 overflow-y-auto mb-6'
                    }, [
                        React.createElement('h3', {
                            key: 'log-title',
                            className: 'text-white font-bold mb-2'
                        }, '„Éê„Éà„É´„É≠„Ç∞'),
                        React.createElement('div', {
                            key: 'log-content',
                            className: 'space-y-1'
                        }, gameState.battleLog.map((log, index) =>
                            React.createElement('div', {
                                key: `log-${index}`,
                                className: 'text-gray-300 text-sm'
                            }, `> ${log}`)
                        ))
                    ]),

                    // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„Å®„Éû„ÉÉ„ÉóÈÅ∑Áßª„Éú„Çø„É≥
                    React.createElement('div', {
                        key: 'reset-section',
                        className: 'text-center space-x-4'
                    }, [
                        React.createElement('button', {
                            key: 'reset-button',
                            onClick: resetGame,
                            className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95'
                        }, '„Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà'),
                        React.createElement('button', {
                            key: 'map-masara-button',
                            onClick: () => navigateToMap && navigateToMap('masara', null, null),
                            className: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95'
                        }, 'üó∫Ô∏è „Éû„Çµ„É©„Çø„Ç¶„É≥„Å∏'),
                        React.createElement('button', {
                            key: 'map-shion-button',
                            onClick: () => navigateToMap && navigateToMap('shion', null, null),
                            className: 'bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95'
                        }, 'üó∫Ô∏è „Ç∑„Ç™„É≥„Çø„Ç¶„É≥„Å∏')
                    ])
                ]),

                // „Éù„Ç±„É¢„É≥ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´
                gameState.showPokemonSelector && React.createElement('div', {
                    key: 'pokemon-selector-modal',
                    className: 'fixed inset-0 pokemon-selector flex items-center justify-center z-50'
                }, React.createElement('div', {
                    key: 'selector-content',
                    className: 'bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto'
                }, [
                    React.createElement('h2', {
                        key: 'selector-title',
                        className: 'text-2xl font-bold text-gray-800 mb-4 text-center'
                    }, `${gameState.selectorMode === 'player' ? '„Éó„É¨„Ç§„É§„Éº' : 'CPU'}„ÅÆ„Éù„Ç±„É¢„É≥„ÇíÈÅ∏Êäû`),
                    React.createElement('div', {
                        key: 'pokemon-grid',
                        className: 'grid grid-cols-2 md:grid-cols-4 gap-4'
                    }, Object.entries(pokemonDatabase).filter(([key]) => key !== 'angrymasterenraged').map(([key, pokemon]) =>
                        React.createElement('div', {
                            key: `pokemon-${key}`,
                            onClick: () => selectPokemon(key),
                            className: `pokemon-card p-4 rounded-lg border-2 border-gray-200 text-center cursor-pointer ${(gameState.selectorMode === 'player' && gameState.playerPokemon === key) ||
                                (gameState.selectorMode === 'enemy' && gameState.enemyPokemon === key) ? 'selected' : ''
                                }`
                        }, [
                            React.createElement('img', {
                                key: 'pokemon-img',
                                src: pokemon.image,
                                alt: pokemon.name,
                                className: 'w-16 h-16 mx-auto mb-2',
                                style: { imageRendering: 'pixelated' }
                            }),
                            React.createElement('div', {
                                key: 'pokemon-name',
                                className: 'font-bold text-gray-800'
                            }, pokemon.name),
                            React.createElement('div', {
                                key: 'pokemon-type',
                                className: 'text-sm text-gray-600'
                            }, pokemon.type + '„Çø„Ç§„Éó')
                        ])
                    )),
                    React.createElement('button', {
                        key: 'close-selector',
                        onClick: () => setGameState(prev => ({ ...prev, showPokemonSelector: false, selectorMode: null })),
                        className: 'mt-4 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded'
                    }, '„Ç≠„É£„É≥„Çª„É´')
                ])),

                // ÂãùÂà©„É¢„Éº„ÉÄ„É´
                gameState.showWinModal && React.createElement('div', {
                    key: 'win-modal-overlay',
                    className: 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50',
                    onClick: () => setGameState(prev => ({ ...prev, showWinModal: false }))
                }, React.createElement('div', {
                    key: 'win-modal-content',
                    className: 'win-modal bg-gradient-to-br from-yellow-400 via-yellow-300 to-yellow-500 rounded-3xl p-12 shadow-2xl border-8 border-yellow-600',
                    onClick: (e) => e.stopPropagation()
                }, [
                    React.createElement('div', {
                        key: 'win-text-container',
                        className: 'text-center'
                    }, [
                        React.createElement('div', {
                            key: 'win-text',
                            className: 'win-text text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-orange-500 to-yellow-600 mb-8 drop-shadow-2xl',
                            style: {
                                WebkitTextStroke: '3px #B45309',
                                textShadow: '0 10px 30px rgba(0,0,0,0.5)'
                            }
                        }, gameState.winner === 'player' ? 'WIN!' : 'LOSE!'),
                        React.createElement('img', {
                            key: 'winner-image',
                            src: gameState.winner === 'player' ? getCurrentPokemon('playerPokemon').image : getCurrentPokemon('enemyPokemon').image,
                            alt: gameState.winner === 'player' ? getCurrentPokemon('playerPokemon').name : getCurrentPokemon('enemyPokemon').name,
                            className: 'w-48 h-48 mx-auto mb-6 drop-shadow-2xl bounce',
                            style: {
                                imageRendering: 'pixelated',
                                filter: 'drop-shadow(0 0 20px rgba(255, 215, 0, 0.8))'
                            }
                        }),
                        React.createElement('div', {
                            key: 'winner-name',
                            className: 'text-4xl font-bold text-gray-800 mb-8 drop-shadow-lg'
                        }, gameState.winner === 'player'
                            ? `${getCurrentPokemon('playerPokemon').name}„ÅÆÂãùÂà©ÔºÅ`
                            : `${getCurrentPokemon('enemyPokemon').name}„ÅÆÂãùÂà©ÔºÅ`),
                        React.createElement('div', {
                            key: 'win-modal-buttons',
                            className: 'flex gap-4 justify-center'
                        }, [
                            React.createElement('button', {
                                key: 'close-win-modal',
                                onClick: () => setGameState(prev => ({ ...prev, showWinModal: false })),
                                className: 'bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-8 rounded-full text-xl transform hover:scale-105 transition-all duration-200 shadow-xl'
                            }, 'Èñâ„Åò„Çã'),
                            gameState.fromMap && React.createElement('button', {
                                key: 'return-to-map',
                                onClick: () => {
                                    if (navigateToMap && gameState.playerPosition) {
                                        navigateToMap(gameState.fromMap, gameState.playerPosition.x, gameState.playerPosition.y);
                                    }
                                },
                                className: 'bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-full text-xl transform hover:scale-105 transition-all duration-200 shadow-xl'
                            }, 'üó∫Ô∏è „Éû„ÉÉ„Éó„Å´Êàª„Çã')
                        ])
                    ])
                ])),

                // „Éñ„ÉÅ„ÇÆ„É¨„É¢„Éº„ÉÄ„É´
                gameState.showEnrageModal && React.createElement('div', {
                    key: 'enrage-modal-overlay',
                    className: 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50'
                }, React.createElement('div', {
                    key: 'enrage-modal-content',
                    className: 'win-modal text-center'
                }, [
                    React.createElement('img', {
                        key: 'enrage-image',
                        src: '„Åà„ÅàÂä†Ê∏õ„Å´„Åó„Çà„Åó.png',
                        alt: '„Éñ„ÉÅ„ÇÆ„É¨„ÅüÔºÅ',
                        className: 'w-96 h-96 mx-auto drop-shadow-2xl',
                        style: {
                            filter: 'drop-shadow(0 0 30px rgba(255, 0, 0, 0.9))'
                        }
                    })
                ]))
            ]);
        };

        // ===== MasaraTownComponent =====
        const MasaraTownComponent = ({ playerRef, bgmPlayerReady, navigateToBattle, navigateToScreen, transitionInfo }) => {
            // transitionInfo„Åã„Çâ‰ΩçÁΩÆ„ÇíÂèñÂæó
            const getInitialPosition = () => {
                if (transitionInfo && transitionInfo.playerX !== undefined && transitionInfo.playerY !== undefined) {
                    return { x: parseInt(transitionInfo.playerX), y: parseInt(transitionInfo.playerY) };
                }
                return { x: 5, y: 5 }; // „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ
            };

            const [gameState, setGameState] = React.useState({
                playerPosition: getInitialPosition(),
                mapData: window.masaraTownMap || [],
                isMoving: false,
                encounterChance: 0,
                showEncounterNotification: false,
                encounterPokemon: null,
                isEncountering: false,
                fadeOpacity: 1.0
            });

            // transitionInfo„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´„Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            React.useEffect(() => {
                if (transitionInfo && transitionInfo.playerX !== undefined && transitionInfo.playerY !== undefined) {
                    setGameState(prev => ({
                        ...prev,
                        playerPosition: { x: parseInt(transitionInfo.playerX), y: parseInt(transitionInfo.playerY) }
                    }));
                }
            }, [transitionInfo]);

            // „Éû„ÉÉ„Éó„Éá„Éº„Çø„ÅÆÂàùÊúüÂåñ
            React.useEffect(() => {
                if (window.masaraTownMap && window.masaraTownMap.length > 0) {
                    setGameState(prev => ({ ...prev, mapData: window.masaraTownMap }));
                }
            }, []);

            // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂá¶ÁêÜ
            React.useEffect(() => {
                const handleKeyPress = (e) => {
                    if (gameState.isMoving || gameState.isEncountering) return;

                    const { x, y } = gameState.playerPosition;
                    let newX = x;
                    let newY = y;

                    switch (e.key) {
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            newY = Math.max(0, y - 1);
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            newY = Math.min(gameState.mapData.length - 1, y + 1);
                            break;
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            newX = Math.max(0, x - 1);
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            newX = Math.min(gameState.mapData[0].length - 1, x + 1);
                            break;
                        default:
                            return;
                    }

                    if (gameState.mapData[newY] && gameState.mapData[newY][newX] && gameState.mapData[newY][newX].walkable) {
                        setGameState(prev => ({ ...prev, isMoving: true }));

                        setTimeout(() => {
                            setGameState(prev => {
                                const newState = { ...prev, playerPosition: { x: newX, y: newY }, isMoving: false };
                                const currentTile = prev.mapData[newY][newX];
                                if (currentTile.type === 'grass' && !prev.isEncountering) {
                                    const encounterRate = Math.random();
                                    if (encounterRate < 0.15) {
                                        const wildPokemon = window.getRandomWildPokemon('masara');
                                        if (wildPokemon) {
                                            setGameState(prevState => ({ ...prevState, isEncountering: true, encounterPokemon: wildPokemon }));
                                            const bgmStartTime = Date.now();

                                            setTimeout(() => {
                                                // „Éû„ÉÉ„Éó„ÅÆBGM„ÇíÂÅúÊ≠¢
                                                if (playerRef.current) {
                                                    try {
                                                        playerRef.current.pauseVideo();
                                                        console.log('„Éû„ÉÉ„ÉóBGM„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
                                                    } catch (error) {
                                                        console.log('„Éû„ÉÉ„ÉóBGMÂÅúÊ≠¢„Ç®„É©„Éº:', error);
                                                    }
                                                }

                                                // „Éê„Éà„É´Áî®„Éó„É¨„Ç§„É§„Éº„Çí‰ΩøÁî®Ôºà„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇÔºâ
                                                const battlePlayer = window.battlePlayerRef?.current;
                                                if (battlePlayer && window.battlePlayerReady) {
                                                    try {
                                                        battlePlayer.seekTo(408, true);
                                                        battlePlayer.setVolume(30);
                                                        battlePlayer.playVideo();
                                                        console.log('„Ç®„É≥„Ç´„Ç¶„É≥„ÉàBGM„ÇíÂÜçÁîü„Åó„Åæ„Åó„Åü');
                                                    } catch (error) {
                                                        console.log('BGMÂÜçÁîü„Ç®„É©„Éº:', error);
                                                    }
                                                }
                                            }, 100);

                                            let opacity = 1.0;
                                            const fadeInterval = setInterval(() => {
                                                opacity -= 0.0167;
                                                setGameState(prevState => ({ ...prevState, fadeOpacity: opacity }));

                                                if (opacity <= 0) {
                                                    clearInterval(fadeInterval);
                                                    // „É™„É≠„Éº„Éâ„Åõ„Åö„Å´ÁîªÈù¢„ÇíÂàá„ÇäÊõø„ÅàÔºàBGM„ÇíÂàá„Çâ„Åï„Å™„ÅÑÔºâ
                                                    if (navigateToBattle) {
                                                        navigateToBattle(wildPokemon, 'masara', newX, newY, bgmStartTime);
                                                    }
                                                }
                                            }, 50);
                                        }
                                    }
                                }
                                return newState;
                            });
                        }, 200);
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [gameState.playerPosition, gameState.mapData, gameState.isMoving, gameState.isEncountering, playerRef, bgmPlayerReady, navigateToBattle]);

            const renderTile = (tile, row, col) => {
                const isPlayer = gameState.playerPosition.x === col && gameState.playerPosition.y === row;
                let tileClass = 'w-12 h-12 border border-gray-600 flex items-center justify-center';
                if (tile.type === 'grass') tileClass += ' grass-tile';
                else if (tile.type === 'path') tileClass += ' path-tile';
                else if (tile.type === 'house') tileClass += ' house-tile';

                return React.createElement('div', {
                    key: `tile-${row}-${col}`,
                    className: tileClass
                }, isPlayer ? React.createElement('img', {
                    src: '„Éù„Ç±„É¢„É≥„Éà„É¨„Éº„Éä„Éº_1.png',
                    alt: '„Éó„É¨„Ç§„É§„Éº',
                    className: 'player walk-animation',
                    style: { width: '2rem', height: '2rem', objectFit: 'contain', imageRendering: 'pixelated' }
                }) : null);
            };

            return React.createElement('div', {
                className: 'min-h-screen bg-gradient-to-b from-blue-900 via-blue-800 to-green-800 p-4 relative',
                style: gameState.isEncountering ? { filter: 'brightness(0.8)' } : {}
            }, [
                gameState.isEncountering && React.createElement('div', {
                    key: 'fade-overlay',
                    className: 'fade-overlay',
                    style: { opacity: 1 - gameState.fadeOpacity }
                }),
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center mb-6'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-4xl font-bold text-white mb-2 drop-shadow-lg'
                    }, '„Éû„Çµ„É©„Çø„Ç¶„É≥'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg text-yellow-300 drop-shadow-md'
                    }, 'Áü¢Âç∞„Ç≠„Éº„Åæ„Åü„ÅØWASD„ÅßÁßªÂãï'),
                    gameState.isEncountering && React.createElement('div', {
                        key: 'encounter-message',
                        className: 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[10000] text-white text-3xl font-bold text-center bg-black/90 px-10 py-6 rounded-lg animate-pulse border-4 border-yellow-400',
                        style: { opacity: Math.min(1, 1.5 - gameState.fadeOpacity) }
                    }, [
                        gameState.encounterPokemon === 'pikachu' && React.createElement('img', {
                            key: 'pikachu-encounter-image',
                            src: '„Éî„Ç´„ÉÅ„É•„Ç¶ÈÅ≠ÈÅá.png',
                            alt: '„Éî„Ç´„ÉÅ„É•„Ç¶ÈÅ≠ÈÅá',
                            className: 'mx-auto mb-4',
                            style: { width: '300px', height: 'auto', imageRendering: 'pixelated', filter: 'drop-shadow(0 0 20px rgba(255, 255, 0, 0.8))' }
                        }),
                        React.createElement('div', { key: 'encounter-text', className: 'mb-3' }, 'ÈáéÁîü„ÅÆ„Éù„Ç±„É¢„É≥„ÅåÁèæ„Çå„ÅüÔºÅ'),
                        gameState.encounterPokemon && window.pokemonDatabase && window.pokemonDatabase[gameState.encounterPokemon] && React.createElement('div', {
                            key: 'pokemon-name',
                            className: 'text-2xl mt-3 text-yellow-300 font-black'
                        }, window.pokemonDatabase[gameState.encounterPokemon].name + '„ÅåÁèæ„Çå„ÅüÔºÅ')
                    ])
                ]),
                React.createElement('div', {
                    key: 'map-container',
                    className: `flex justify-center items-center mb-6 ${gameState.isEncountering ? 'encounter-shake' : ''}`
                }, React.createElement('div', {
                    className: 'bg-black/50 p-4 rounded-lg shadow-2xl'
                }, gameState.mapData.map((row, rowIndex) =>
                    React.createElement('div', {
                        key: `row-${rowIndex}`,
                        className: 'flex'
                    }, row.map((tile, colIndex) => renderTile(tile, rowIndex, colIndex)))
                ))),
                React.createElement('div', {
                    key: 'menu-buttons',
                    className: 'text-center'
                }, React.createElement('button', {
                    onClick: () => navigateToScreen && navigateToScreen('battle'),
                    className: 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105'
                }, '„Éê„Éà„É´ÁîªÈù¢„Å´Êàª„Çã'))
            ]);
        };

        // ===== ShionTownComponent =====
        const ShionTownComponent = ({ playerRef, bgmPlayerReady, navigateToBattle, navigateToScreen, transitionInfo }) => {
            const getInitialPosition = () => {
                if (transitionInfo && transitionInfo.playerX !== undefined && transitionInfo.playerY !== undefined) {
                    return { x: parseInt(transitionInfo.playerX), y: parseInt(transitionInfo.playerY) };
                }
                return { x: 7, y: 7 };
            };

            const [gameState, setGameState] = React.useState({
                playerPosition: getInitialPosition(),
                mapData: window.shionTownMap || [],
                isMoving: false,
                encounterChance: 0,
                showEncounterNotification: false,
                encounterPokemon: null,
                isEncountering: false,
                fadeOpacity: 1.0
            });

            // transitionInfo„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´„Éó„É¨„Ç§„É§„Éº‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            React.useEffect(() => {
                if (transitionInfo && transitionInfo.playerX !== undefined && transitionInfo.playerY !== undefined) {
                    setGameState(prev => ({
                        ...prev,
                        playerPosition: { x: parseInt(transitionInfo.playerX), y: parseInt(transitionInfo.playerY) }
                    }));
                }
            }, [transitionInfo]);

            React.useEffect(() => {
                if (window.shionTownMap && window.shionTownMap.length > 0) {
                    setGameState(prev => ({ ...prev, mapData: window.shionTownMap }));
                }
            }, []);

            React.useEffect(() => {
                const handleKeyPress = (e) => {
                    if (gameState.isMoving || gameState.isEncountering) return;
                    const { x, y } = gameState.playerPosition;
                    let newX = x;
                    let newY = y;

                    switch (e.key) {
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            newY = Math.max(0, y - 1);
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            newY = Math.min(gameState.mapData.length - 1, y + 1);
                            break;
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            newX = Math.max(0, x - 1);
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            newX = Math.min(gameState.mapData[0].length - 1, x + 1);
                            break;
                        default:
                            return;
                    }

                    if (gameState.mapData[newY] && gameState.mapData[newY][newX] && gameState.mapData[newY][newX].walkable) {
                        setGameState(prev => ({ ...prev, isMoving: true }));

                        setTimeout(() => {
                            setGameState(prev => {
                                const newState = { ...prev, playerPosition: { x: newX, y: newY }, isMoving: false };
                                const currentTile = prev.mapData[newY][newX];
                                if (currentTile.type === 'grass' && !prev.isEncountering) {
                                    const encounterRate = Math.random();
                                    if (encounterRate < 0.18) {
                                        const wildPokemon = window.getRandomWildPokemon('shion');
                                        if (wildPokemon) {
                                            setGameState(prevState => ({ ...prevState, isEncountering: true, encounterPokemon: wildPokemon }));
                                            const bgmStartTime = Date.now();

                                            setTimeout(() => {
                                                // „Éû„ÉÉ„Éó„ÅÆBGM„ÇíÂÅúÊ≠¢
                                                if (playerRef.current) {
                                                    try {
                                                        playerRef.current.pauseVideo();
                                                        console.log('„Éû„ÉÉ„ÉóBGM„ÇíÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
                                                    } catch (error) {
                                                        console.log('„Éû„ÉÉ„ÉóBGMÂÅúÊ≠¢„Ç®„É©„Éº:', error);
                                                    }
                                                }

                                                // „Éê„Éà„É´Áî®„Éó„É¨„Ç§„É§„Éº„Çí‰ΩøÁî®Ôºà„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇÔºâ
                                                const battlePlayer = window.battlePlayerRef?.current;
                                                if (battlePlayer && window.battlePlayerReady) {
                                                    try {
                                                        battlePlayer.seekTo(408, true);
                                                        battlePlayer.setVolume(30);
                                                        battlePlayer.playVideo();
                                                        console.log('„Ç®„É≥„Ç´„Ç¶„É≥„ÉàBGM„ÇíÂÜçÁîü„Åó„Åæ„Åó„Åü');
                                                    } catch (error) {
                                                        console.log('BGMÂÜçÁîü„Ç®„É©„Éº:', error);
                                                    }
                                                }
                                            }, 100);

                                            let opacity = 1.0;
                                            const fadeInterval = setInterval(() => {
                                                opacity -= 0.0167;
                                                setGameState(prevState => ({ ...prevState, fadeOpacity: opacity }));

                                                if (opacity <= 0) {
                                                    clearInterval(fadeInterval);
                                                    if (navigateToBattle) {
                                                        navigateToBattle(wildPokemon, 'shion', newX, newY, bgmStartTime);
                                                    }
                                                }
                                            }, 50);
                                        }
                                    }
                                }
                                return newState;
                            });
                        }, 200);
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => window.removeEventListener('keydown', handleKeyPress);
            }, [gameState.playerPosition, gameState.mapData, gameState.isMoving, gameState.isEncountering, playerRef, bgmPlayerReady, navigateToBattle]);

            const renderTile = (tile, row, col) => {
                const isPlayer = gameState.playerPosition.x === col && gameState.playerPosition.y === row;
                let tileClass = 'w-10 h-10 border border-gray-600 flex items-center justify-center relative';
                if (tile.type === 'grass') tileClass += ' grass-tile';
                else if (tile.type === 'path') tileClass += ' path-tile';
                else if (tile.type === 'house') tileClass += ' house-tile';
                else if (tile.type === 'water') tileClass += ' water-tile';
                else if (tile.type === 'pokemonCenter') tileClass += ' pokemon-center-tile';

                return React.createElement('div', {
                    key: `tile-${row}-${col}`,
                    className: tileClass
                }, [
                    tile.type === 'pokemonCenter' && React.createElement('img', {
                        key: 'center-image',
                        src: '„Éù„Ç±„É¢„É≥„Çª„É≥„Çø„Éº.png',
                        alt: '„Éù„Ç±„É¢„É≥„Çª„É≥„Çø„Éº',
                        className: 'absolute inset-0 w-full h-full object-cover opacity-80',
                        style: { imageRendering: 'pixelated' }
                    }),
                    isPlayer && React.createElement('img', {
                        key: 'player-image',
                        src: '„Éù„Ç±„É¢„É≥„Éà„É¨„Éº„Éä„Éº_1.png',
                        alt: '„Éó„É¨„Ç§„É§„Éº',
                        className: 'player walk-animation relative z-10',
                        style: { width: '2rem', height: '2rem', objectFit: 'contain', imageRendering: 'pixelated' }
                    })
                ]);
            };

            return React.createElement('div', {
                className: 'min-h-screen bg-gradient-to-b from-purple-900 via-purple-800 to-indigo-800 p-4 relative',
                style: gameState.isEncountering ? { filter: 'brightness(0.8)' } : {}
            }, [
                gameState.isEncountering && React.createElement('div', {
                    key: 'fade-overlay',
                    className: 'fade-overlay',
                    style: { opacity: 1 - gameState.fadeOpacity }
                }),
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center mb-6'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-4xl font-bold text-white mb-2 drop-shadow-lg'
                    }, '„Ç∑„Ç™„É≥„Çø„Ç¶„É≥'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-lg text-yellow-300 drop-shadow-md'
                    }, 'Áü¢Âç∞„Ç≠„Éº„Åæ„Åü„ÅØWASD„ÅßÁßªÂãï'),
                    gameState.isEncountering && React.createElement('div', {
                        key: 'encounter-message',
                        className: 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-[10000] text-white text-3xl font-bold text-center bg-black/90 px-10 py-6 rounded-lg animate-pulse border-4 border-yellow-400',
                        style: { opacity: Math.min(1, 1.5 - gameState.fadeOpacity) }
                    }, [
                        gameState.encounterPokemon === 'pikachu' && React.createElement('img', {
                            key: 'pikachu-encounter-image',
                            src: '„Éî„Ç´„ÉÅ„É•„Ç¶ÈÅ≠ÈÅá.png',
                            alt: '„Éî„Ç´„ÉÅ„É•„Ç¶ÈÅ≠ÈÅá',
                            className: 'mx-auto mb-4',
                            style: { width: '300px', height: 'auto', imageRendering: 'pixelated', filter: 'drop-shadow(0 0 20px rgba(255, 255, 0, 0.8))' }
                        }),
                        React.createElement('div', { key: 'encounter-text', className: 'mb-3' }, 'ÈáéÁîü„ÅÆ„Éù„Ç±„É¢„É≥„ÅåÁèæ„Çå„ÅüÔºÅ'),
                        gameState.encounterPokemon && window.pokemonDatabase && window.pokemonDatabase[gameState.encounterPokemon] && React.createElement('div', {
                            key: 'pokemon-name',
                            className: 'text-2xl mt-3 text-yellow-300 font-black'
                        }, window.pokemonDatabase[gameState.encounterPokemon].name + '„ÅåÁèæ„Çå„ÅüÔºÅ')
                    ])
                ]),
                React.createElement('div', {
                    key: 'map-container',
                    className: `flex justify-center items-center mb-6 overflow-x-auto ${gameState.isEncountering ? 'encounter-shake' : ''}`
                }, React.createElement('div', {
                    className: 'bg-black/50 p-4 rounded-lg shadow-2xl'
                }, gameState.mapData.map((row, rowIndex) =>
                    React.createElement('div', {
                        key: `row-${rowIndex}`,
                        className: 'flex'
                    }, row.map((tile, colIndex) => renderTile(tile, rowIndex, colIndex)))
                ))),
                React.createElement('div', {
                    key: 'menu-buttons',
                    className: 'text-center'
                }, React.createElement('button', {
                    onClick: () => navigateToScreen && navigateToScreen('battle'),
                    className: 'bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105'
                }, '„Éê„Éà„É´ÁîªÈù¢„Å´Êàª„Çã'))
            ]);
        };

        // ===== App„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÔºàÁîªÈù¢Âàá„ÇäÊõø„Åà„ÇíÁÆ°ÁêÜÔºâ =====
        const App = () => {
            // ÁîªÈù¢Âàá„ÇäÊõø„Åà„ÅÆÁä∂ÊÖãÁÆ°ÁêÜÔºà'battle', 'masara', 'shion'Ôºâ
            const [currentScreen, setCurrentScreen] = React.useState(() => {
                // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÂàùÊúüÁîªÈù¢„ÇíÊ±∫ÂÆö
                const urlParams = new URLSearchParams(window.location.search);
                const from = urlParams.get('from');
                if (from === 'masara') return 'masara';
                if (from === 'shion') return 'shion';
                return 'battle'; // „Éá„Éï„Ç©„É´„Éà„ÅØ„Éê„Éà„É´ÁîªÈù¢
            });

            // „Éû„ÉÉ„Éó„Åã„Çâ„ÅÆÈÅ∑ÁßªÊÉÖÂ†±Ôºà„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇÔºâ
            const [transitionInfo, setTransitionInfo] = React.useState(null);

            // YouTube„Éó„É¨„Ç§„É§„Éº„ÅÆ„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí3„Å§‰ΩúÊàêÔºà„Éê„Éà„É´Áî®„ÄÅ„Éû„Çµ„É©„Çø„Ç¶„É≥Áî®„ÄÅ„Ç∑„Ç™„É≥„Çø„Ç¶„É≥Áî®Ôºâ
            const battlePlayerRef = React.useRef(null);
            const masaraPlayerRef = React.useRef(null);
            const shionPlayerRef = React.useRef(null);
            const [battlePlayerReady, setBattlePlayerReady] = React.useState(false);
            const [masaraPlayerReady, setMasaraPlayerReady] = React.useState(false);
            const [shionPlayerReady, setShionPlayerReady] = React.useState(false);

            // YouTube„Éó„É¨„Ç§„É§„Éº„ÅÆÂàùÊúüÂåñÔºà3„Å§„Åô„Åπ„Å¶‰ΩúÊàêÔºâ
            React.useEffect(() => {
                if (typeof YT === 'undefined') {
                    console.log('YouTube API not loaded yet');
                    return;
                }

                const initYouTubePlayers = () => {
                    // „Éê„Éà„É´Áî®„Éó„É¨„Ç§„É§„Éº
                    try {
                        battlePlayerRef.current = new YT.Player('yt-player-battle', {
                            videoId: 'Q53CDIGPJ58',
                            height: '0',
                            width: '0',
                            playerVars: {
                                start: 408,
                                end: 489,
                                loop: 1,
                                playlist: 'Q53CDIGPJ58',
                                controls: 0,
                                disablekb: 1,
                                rel: 0,
                                playsinline: 1,
                                autoplay: 0,
                                mute: 0
                            },
                            events: {
                                onReady: (event) => {
                                    console.log('Battle YouTube player ready');
                                    event.target.setVolume(30);
                                    setBattlePlayerReady(true);
                                },
                                onStateChange: (event) => {
                                    if (event.data === YT.PlayerState.ENDED) {
                                        event.target.seekTo(408);
                                        event.target.playVideo();
                                    }
                                },
                                onError: (event) => {
                                    console.log('Battle YouTube player error:', event.data);
                                }
                            }
                        });
                    } catch (error) {
                        console.log('Battle YouTube player creation error:', error);
                    }

                    // „Éû„Çµ„É©„Çø„Ç¶„É≥Áî®„Éó„É¨„Ç§„É§„Éº
                    try {
                        masaraPlayerRef.current = new YT.Player('yt-player-masara', {
                            videoId: 'kv1BrNq_ONs',
                            height: '0',
                            width: '0',
                            playerVars: {
                                controls: 0,
                                disablekb: 1,
                                rel: 0,
                                playsinline: 1,
                                autoplay: 0,
                                mute: 0,
                                loop: 1,
                                playlist: 'kv1BrNq_ONs'
                            },
                            events: {
                                onReady: (event) => {
                                    console.log('Masara Town YouTube player ready');
                                    event.target.setVolume(30);
                                    setMasaraPlayerReady(true);
                                },
                                onStateChange: (event) => {
                                    if (event.data === YT.PlayerState.ENDED) {
                                        event.target.seekTo(0);
                                        event.target.playVideo();
                                    }
                                },
                                onError: (event) => {
                                    console.log('Masara YouTube player error:', event.data);
                                }
                            }
                        });
                    } catch (error) {
                        console.log('Masara YouTube player creation error:', error);
                    }

                    // „Ç∑„Ç™„É≥„Çø„Ç¶„É≥Áî®„Éó„É¨„Ç§„É§„Éº
                    try {
                        shionPlayerRef.current = new YT.Player('yt-player-shion', {
                            videoId: 'wqTlXvraAic',
                            height: '0',
                            width: '0',
                            playerVars: {
                                controls: 0,
                                disablekb: 1,
                                rel: 0,
                                playsinline: 1,
                                autoplay: 0,
                                mute: 0,
                                loop: 1,
                                playlist: 'wqTlXvraAic'
                            },
                            events: {
                                onReady: (event) => {
                                    console.log('Shion Town YouTube player ready');
                                    event.target.setVolume(30);
                                    setShionPlayerReady(true);
                                },
                                onStateChange: (event) => {
                                    if (event.data === YT.PlayerState.ENDED) {
                                        event.target.seekTo(0);
                                        event.target.playVideo();
                                    }
                                },
                                onError: (event) => {
                                    console.log('Shion YouTube player error:', event.data);
                                }
                            }
                        });
                    } catch (error) {
                        console.log('Shion YouTube player creation error:', error);
                    }
                };

                if (YT && YT.Player) {
                    initYouTubePlayers();
                } else {
                    window.onYouTubeIframeAPIReady = initYouTubePlayers;
                }
            }, []);

            // ÁîªÈù¢Âàá„ÇäÊõø„ÅàÊôÇ„Å´BGM„ÇíÂàá„ÇäÊõø„Åà
            React.useEffect(() => {
                if (currentScreen === 'battle') {
                    // „Éê„Éà„É´ÁîªÈù¢Ôºö„Éê„Éà„É´BGM„ÇíÂÜçÁîü„ÄÅ‰ªñ„ÅÆBGM„ÇíÂÅúÊ≠¢
                    if (masaraPlayerRef.current) {
                        try {
                            masaraPlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                    if (shionPlayerRef.current) {
                        try {
                            shionPlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                } else if (currentScreen === 'masara') {
                    // „Éû„Çµ„É©„Çø„Ç¶„É≥Ôºö„Éû„Çµ„É©„Çø„Ç¶„É≥BGM„ÇíÂÜçÁîü„ÄÅ‰ªñ„ÅÆBGM„ÇíÂÅúÊ≠¢
                    if (battlePlayerRef.current) {
                        try {
                            battlePlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                    if (shionPlayerRef.current) {
                        try {
                            shionPlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                    if (masaraPlayerRef.current && masaraPlayerReady) {
                        try {
                            masaraPlayerRef.current.seekTo(0, true);
                            masaraPlayerRef.current.playVideo();
                            console.log('„Éû„Çµ„É©„Çø„Ç¶„É≥BGM„ÇíÂÜçÁîü');
                        } catch (e) {
                            console.log('„Éû„Çµ„É©„Çø„Ç¶„É≥BGMÂÜçÁîü„Ç®„É©„Éº:', e);
                        }
                    }
                } else if (currentScreen === 'shion') {
                    // „Ç∑„Ç™„É≥„Çø„Ç¶„É≥Ôºö„Ç∑„Ç™„É≥„Çø„Ç¶„É≥BGM„ÇíÂÜçÁîü„ÄÅ‰ªñ„ÅÆBGM„ÇíÂÅúÊ≠¢
                    if (battlePlayerRef.current) {
                        try {
                            battlePlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                    if (masaraPlayerRef.current) {
                        try {
                            masaraPlayerRef.current.pauseVideo();
                        } catch (e) { }
                    }
                    if (shionPlayerRef.current && shionPlayerReady) {
                        try {
                            shionPlayerRef.current.seekTo(0, true);
                            shionPlayerRef.current.playVideo();
                            console.log('„Ç∑„Ç™„É≥„Çø„Ç¶„É≥BGM„ÇíÂÜçÁîü');
                        } catch (e) {
                            console.log('„Ç∑„Ç™„É≥„Çø„Ç¶„É≥BGMÂÜçÁîü„Ç®„É©„Éº:', e);
                        }
                    }
                }
            }, [currentScreen, masaraPlayerReady, shionPlayerReady]);

            // „Éê„Éà„É´„Éó„É¨„Ç§„É§„Éº„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇ„Å´‰ΩøÁî®Ôºâ
            React.useEffect(() => {
                window.battlePlayerRef = battlePlayerRef;
                window.battlePlayerReady = battlePlayerReady;
            }, [battlePlayerReady]);

            // ÁîªÈù¢Âàá„ÇäÊõø„ÅàÈñ¢Êï∞
            const navigateToScreen = (screen, data = null) => {
                setCurrentScreen(screen);
                if (data) {
                    setTransitionInfo(data);
                }
            };

            // „Éû„ÉÉ„Éó„Åã„Çâ„Éê„Éà„É´„Å∏„ÅÆÈÅ∑ÁßªÔºà„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇÔºâ
            const navigateToBattle = (enemyPokemon, fromMap, playerX, playerY, bgmStartTime) => {
                // „Éê„Éà„É´BGM„ÅØÊó¢„Å´„Ç®„É≥„Ç´„Ç¶„É≥„ÉàÊôÇ„Å´ÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„ÄÅ„Åù„ÅÆ„Åæ„ÅæÁ∂ôÁ∂ö
                // „Éê„Éà„É´ÁîªÈù¢„Å´ÈÅ∑Áßª
                setTransitionInfo({
                    enemyPokemon: enemyPokemon,
                    fromMap: fromMap,
                    playerX: playerX,
                    playerY: playerY,
                    bgmStartTime: bgmStartTime
                });
                setCurrentScreen('battle');
            };

            // „Éê„Éà„É´„Åã„Çâ„Éû„ÉÉ„Éó„Å∏„ÅÆÈÅ∑Áßª
            const navigateToMap = (mapName, playerX, playerY) => {
                setTransitionInfo({
                    playerX: playerX !== null ? playerX : (mapName === 'masara' ? 5 : 7),
                    playerY: playerY !== null ? playerY : (mapName === 'masara' ? 5 : 7)
                });
                setCurrentScreen(mapName);
            };

            return React.createElement('div', {}, [
                // YouTube„Éó„É¨„Ç§„É§„ÉºÔºàÈùûË°®Á§∫„ÄÅÂêÑÁîªÈù¢Áî®Ôºâ
                React.createElement('div', {
                    key: 'youtube-player-battle',
                    id: 'yt-player-battle',
                    style: { position: 'absolute', left: '-9999px', top: '-9999px' }
                }),
                React.createElement('div', {
                    key: 'youtube-player-masara',
                    id: 'yt-player-masara',
                    style: { position: 'absolute', left: '-9999px', top: '-9999px' }
                }),
                React.createElement('div', {
                    key: 'youtube-player-shion',
                    id: 'yt-player-shion',
                    style: { position: 'absolute', left: '-9999px', top: '-9999px' }
                }),
                // ÁèæÂú®„ÅÆÁîªÈù¢„ÇíË°®Á§∫
                currentScreen === 'battle' && React.createElement(PokemonBattleComponent, {
                    key: 'battle-screen',
                    playerRef: battlePlayerRef,
                    bgmPlayerReady: battlePlayerReady,
                    transitionInfo: transitionInfo,
                    navigateToMap: navigateToMap
                }),
                currentScreen === 'masara' && React.createElement(MasaraTownComponent, {
                    key: 'masara-screen',
                    playerRef: masaraPlayerRef,
                    bgmPlayerReady: masaraPlayerReady,
                    navigateToBattle: navigateToBattle,
                    navigateToScreen: navigateToScreen,
                    transitionInfo: transitionInfo
                }),
                currentScreen === 'shion' && React.createElement(ShionTownComponent, {
                    key: 'shion-screen',
                    playerRef: shionPlayerRef,
                    bgmPlayerReady: shionPlayerReady,
                    navigateToBattle: navigateToBattle,
                    navigateToScreen: navigateToScreen,
                    transitionInfo: transitionInfo
                })
            ]);
        };

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>

</html>